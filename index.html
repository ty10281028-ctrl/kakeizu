<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家系図 Webアプリ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent-color: #38bdf8; /* 翡翠/藍の代わりにモダンなスカイブルーを使用 */
            --accent-color-dark: #0ea5e9;
        }
        body {
            font-family: 'Noto Sans JP', sans-serif;
        }
        .accent-bg { background-color: var(--accent-color); }
        .accent-bg-hover:hover { background-color: var(--accent-color-dark); }
        .accent-text { color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }
        .soft-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        #tree-svg {
            cursor: grab;
        }
        #tree-svg:active {
            cursor: grabbing;
        }
        .node .node-card {
            transition: all 0.2s ease-in-out;
        }
        .node:hover .node-card {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .date-selector-group select {
            @apply mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)];
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div id="app" class="h-screen w-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white dark:bg-slate-800 soft-shadow z-10 p-2 sm:p-4 flex items-center justify-between">
            <h1 class="text-xl sm:text-2xl font-bold text-slate-700 dark:text-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1 mr-2 accent-text"><path d="M3 6v12"></path><path d="M18 6v12"></path><path d="M10.5 6h3"></path><path d="M10.5 18h3"></path><path d="M6 12h12"></path></svg>
                家系図
            </h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                 <div id="category-filter-container" class="hidden items-center space-x-2">
                    <label for="category-filter" class="text-sm font-medium hidden sm:block">表示:</label>
                    <select id="category-filter" class="w-32 px-2 py-1 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] text-sm">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>
                <input type="search" id="search-box" placeholder="名前で検索..." class="hidden md:block w-40 sm:w-64 px-3 py-1.5 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition-all text-sm">
                <div id="view-toggle" class="flex items-center border border-slate-300 dark:border-slate-600 rounded-full p-0.5">
                    <button data-view="tree" class="px-3 py-1 text-sm rounded-full bg-slate-200 dark:bg-slate-700">家系図</button>
                    <button data-view="list" class="px-3 py-1 text-sm rounded-full">一覧</button>
                </div>
                 <button id="settings-button" title="設定" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-1 relative overflow-hidden">
            <div id="tree-view" class="w-full h-full">
                <svg id="tree-svg" class="w-full h-full">
                    <g id="tree-container"></g>
                </svg>
            </div>
            <div id="list-view" class="w-full h-full p-4 overflow-y-auto hidden">
                <div class="flex justify-between items-center mb-4">
                     <h2 class="text-lg font-bold">人物一覧 (年齢順)</h2>
                    <button id="add-person-list-btn" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">
                        + 新規追加
                    </button>
                </div>
                <div id="person-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <!-- Person cards will be injected here -->
                </div>
            </div>
        </main>
    </div>

    <!-- Person Details Modal -->
    <div id="person-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">個人情報の編集</h2>
                <button id="close-modal-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="person-form" class="space-y-4">
                    <input type="hidden" id="id">
                     <div class="flex items-start space-x-4">
                        <img id="photoPreview" src="" class="w-24 h-24 rounded-full object-cover bg-slate-200" alt="写真プレビュー">
                        <div class="flex-1 space-y-2">
                            <label for="photoUrl" class="block text-sm font-medium text-slate-600 dark:text-slate-300">写真URL</label>
                            <input type="text" id="photoUrl" placeholder="https://example.com/photo.jpg" class="block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">またはファイルをアップロード:
                                <input type="file" id="photoFile" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                            </label>
                        </div>
                    </div>
                     <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-slate-600 dark:text-slate-300">名前 (必須)</label>
                            <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label for="kana" class="block text-sm font-medium text-slate-600 dark:text-slate-300">フリガナ</label>
                            <input type="text" id="kana" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">生年月日 (必須)</label>
                            <div id="birthdate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                         <div>
                            <label for="gender" class="block text-sm font-medium text-slate-600 dark:text-slate-300">性別</label>
                            <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                                <option value="不明">不明</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                            </select>
                        </div>
                         <div>
                            <label for="fatherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">父親</label>
                            <select id="fatherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                         <div>
                            <label for="motherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">母親</label>
                            <select id="motherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="spouseId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">配偶者</label>
                            <select id="spouseId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">結婚記念日</label>
                            <div id="weddingDate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                        <div class="md:col-span-2">
                             <label for="familyCategory" class="block text-sm font-medium text-slate-600 dark:text-slate-300">所属カテゴリー</label>
                             <select id="familyCategory" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                         </div>
                         <div class="md:col-span-2">
                             <label for="address" class="block text-sm font-medium text-slate-600 dark:text-slate-300">住所</label>
                             <textarea id="address" rows="2" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                         </div>
                         <div class="md:col-span-2">
                             <label for="memo" class="block text-sm font-medium text-slate-600 dark:text-slate-300">メモ</label>
                             <textarea id="memo" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                         </div>
                         <div class="md:col-span-2 flex items-start space-x-4">
                            <label for="isDeceased" class="flex items-center space-x-2 pt-1">
                                <input type="checkbox" id="isDeceased" class="h-4 w-4 rounded border-gray-300 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                                <span>故人</span>
                            </label>
                            <div id="death-date-container" class="hidden flex-1">
                                <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">没年月日</label>
                                <div id="deathdate-container-selectors" class="date-selector-group grid grid-cols-3 gap-2"></div>
                            </div>
                        </div>
                    </div>
                     <!-- Event Timeline -->
                    <div class="pt-4">
                        <h3 class="text-lg font-semibold mb-2">イベントタイムライン</h3>
                        <div id="event-timeline" class="space-y-2 text-sm">
                            <!-- Events will be injected here -->
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-900/50 rounded-b-2xl">
                 <button id="delete-person-button" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">削除</button>
                <div>
                    <button id="cancel-modal-button" class="text-slate-700 dark:text-slate-200 bg-transparent hover:bg-slate-200 dark:hover:bg-slate-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">キャンセル</button>
                    <button id="save-person-button" type="submit" form="person-form" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="close-settings-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="rootPersonId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">家系図の起点となる人物</label>
                    <select id="rootPersonId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                </div>
                <div id="category-manager">
                    <h3 class="text-lg font-semibold mb-2">カテゴリー管理</h3>
                    <div id="category-list" class="space-y-2 mb-2">
                        <!-- category items here -->
                    </div>
                    <div class="flex space-x-2">
                        <input type="text" id="new-category-input" placeholder="新しいカテゴリー名" class="flex-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        <button id="add-category-btn" class="accent-bg text-white px-4 py-2 rounded-md text-sm font-semibold accent-bg-hover transition-colors">追加</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">テーマ</label>
                    <div class="mt-2 flex items-center space-x-4">
                         <label class="flex items-center">
                            <input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ライト</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ダーク</span>
                        </label>
                    </div>
                </div>
                <div class="border-t border-slate-200 dark:border-slate-700 pt-6">
                     <h3 class="text-lg font-semibold mb-2">データ管理</h3>
                     <div class="flex flex-col sm:flex-row gap-2">
                        <button id="import-json" class="flex-1 text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 px-4 py-2 rounded-full text-sm font-semibold transition-colors">JSONインポート</button>
                        <button id="export-json" class="flex-1 accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">JSONエクスポート</button>
                        <input type="file" id="json-file-input" class="hidden" accept=".json">
                    </div>
                     <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <button id="import-csv" class="flex-1 text-slate-700 dark:text-slate-200 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 px-4 py-2 rounded-full text-sm font-semibold transition-colors">CSVインポート</button>
                        <button id="export-csv" class="flex-1 accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">CSVエクスポート</button>
                        <input type="file" id="csv-file-input" class="hidden" accept=".csv">
                    </div>
                </div>
            </div>
        </div>
    </div>


<script>
document.addEventListener('DOMContentLoaded', () => {

    // --- STATE MANAGEMENT ---
    let people = [];
    let familyCategories = [];
    let settings = {
        rootPersonId: null,
        theme: 'light',
    };

    // --- DOM ELEMENTS ---
    const treeViewEl = document.getElementById('tree-view');
    const listViewEl = document.getElementById('list-view');
    const personListContainer = document.getElementById('person-list-container');
    const treeSvg = document.getElementById('tree-svg');
    const treeContainer = document.getElementById('tree-container');
    const categoryFilterContainer = document.getElementById('category-filter-container');
    const categoryFilter = document.getElementById('category-filter');
    
    // Modals
    const personModal = document.getElementById('person-modal');
    const settingsModal = document.getElementById('settings-modal');
    
    // Forms & Inputs
    const personForm = document.getElementById('person-form');
    const searchBox = document.getElementById('search-box');
    
    const nodeSize = { width: 180, height: 80 };
    const nodeGap = { x: 40, y: 80 };

    // --- INITIALIZATION ---
    function init() {
        loadData();
        setupEventListeners();
        applySettings();
        render();
    }

    function loadData() {
        const savedPeople = localStorage.getItem('familyTreePeople');
        const savedSettings = localStorage.getItem('familyTreeSettings');
        const savedCategories = localStorage.getItem('familyTreeCategories');

        if (savedPeople) {
            people = JSON.parse(savedPeople);
        } else {
            people = getSampleData();
        }

        if (savedCategories) {
            familyCategories = JSON.parse(savedCategories);
        } else {
            familyCategories = ['（未分類）', '高橋家', '佐藤家', '鈴木家'];
        }

        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }

        if ((!settings.rootPersonId || !findPersonById(settings.rootPersonId)) && people.length > 0) {
            settings.rootPersonId = people[0].id;
        }
    }
    
    function saveData() {
        localStorage.setItem('familyTreePeople', JSON.stringify(people));
        localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
        localStorage.setItem('familyTreeCategories', JSON.stringify(familyCategories));
    }

    // --- EVENT LISTENERS ---
    function setupEventListeners() {
        // View Toggle
        document.getElementById('view-toggle').addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') switchView(e.target.dataset.view);
        });
        
        // List View Card clicks
        personListContainer.addEventListener('click', (e) => {
            const card = e.target.closest('[data-id]');
            if (card) {
                openPersonModal(card.dataset.id);
            }
        });

        // Modals
        document.getElementById('add-person-list-btn').addEventListener('click', () => openPersonModal());
        document.getElementById('settings-button').addEventListener('click', openSettingsModal);
        document.getElementById('close-modal-button').addEventListener('click', closePersonModal);
        document.getElementById('cancel-modal-button').addEventListener('click', closePersonModal);
        document.getElementById('close-settings-button').addEventListener('click', closeSettingsModal);
        
        // Form Submission
        personForm.addEventListener('submit', handleFormSubmit);
        document.getElementById('delete-person-button').addEventListener('click', handleDeletePerson);

        // Search
        searchBox.addEventListener('input', (e) => renderPersonList(e.target.value));

        // Settings
        document.getElementById('rootPersonId').addEventListener('change', (e) => {
            settings.rootPersonId = e.target.value;
            saveData();
            render();
        });
        document.querySelectorAll('input[name="theme"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                settings.theme = e.target.value;
                applyTheme();
                saveData();
            });
        });
        
        // Data I/O
        document.getElementById('import-json').addEventListener('click', () => document.getElementById('json-file-input').click());
        document.getElementById('export-json').addEventListener('click', exportJSON);
        document.getElementById('json-file-input').addEventListener('change', importJSON);
        document.getElementById('import-csv').addEventListener('click', () => document.getElementById('csv-file-input').click());
        document.getElementById('export-csv').addEventListener('click', exportCSV);
        document.getElementById('csv-file-input').addEventListener('change', importCSV);

        // Category Management
        document.getElementById('add-category-btn').addEventListener('click', addCategory);
        document.getElementById('category-list').addEventListener('click', handleDeleteCategory);
        categoryFilter.addEventListener('change', render);

        // Deceased Checkbox
        document.getElementById('isDeceased').addEventListener('change', (e) => {
            document.getElementById('death-date-container').classList.toggle('hidden', !e.target.checked);
        });
        
        // Photo Upload
        document.getElementById('photoFile').addEventListener('change', handlePhotoFileSelect);
        document.getElementById('photoUrl').addEventListener('input', e => {
             document.getElementById('photoPreview').src = e.target.value || generateAvatar({name: document.getElementById('name').value || '?'});
        });

        // Pan and Zoom for Tree View
        let isPanning = false;
        let startPoint = { x: 0, y: 0 };
        let viewBox = { x: 0, y: 0, w: treeSvg.clientWidth, h: treeSvg.clientHeight };
        
        treeSvg.addEventListener('mousedown', (e) => {
            if (e.target.closest('foreignObject')) return;
            isPanning = true;
            startPoint = { x: e.clientX, y: e.clientY };
            const vb = treeSvg.getAttribute('viewBox').split(' ').map(Number);
            viewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]};
        });

        treeSvg.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            const dx = (startPoint.x - e.clientX) * (viewBox.w / treeSvg.clientWidth);
            const dy = (startPoint.y - e.clientY) * (viewBox.h / treeSvg.clientHeight);
            treeSvg.setAttribute('viewBox', `${viewBox.x + dx} ${viewBox.y + dy} ${viewBox.w} ${viewBox.h}`);
        });
        
        treeSvg.addEventListener('mouseup', () => { isPanning = false; });
        treeSvg.addEventListener('mouseleave', () => { isPanning = false; });

        treeSvg.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = 1.1;
            const { clientX, clientY } = e;
            const vb = treeSvg.getAttribute('viewBox').split(' ').map(Number);
            let viewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]};
            const point = svgPoint(clientX, clientY);
            const newW = e.deltaY > 0 ? viewBox.w * zoomFactor : viewBox.w / zoomFactor;
            const newH = e.deltaY > 0 ? viewBox.h * zoomFactor : viewBox.h / zoomFactor;
            viewBox.x += (point.x - viewBox.x) * (1 - newW / viewBox.w);
            viewBox.y += (point.y - viewBox.y) * (1 - newH / viewBox.h);
            viewBox.w = newW;
            viewBox.h = newH;
            treeSvg.setAttribute('viewBox', `${viewBox.x} ${viewBox.y} ${viewBox.w} ${viewBox.h}`);
        });

        function svgPoint(clientX, clientY) {
            const pt = treeSvg.createSVGPoint();
            pt.x = clientX;
            pt.y = clientY;
            return pt.matrixTransform(treeSvg.getScreenCTM().inverse());
        }
    }

    // --- RENDERING ---
    function render() {
        renderCategoryFilter();
        const currentView = document.querySelector('#view-toggle button[data-view].bg-slate-200')?.dataset.view || 'tree';
        if (currentView === 'tree') {
            renderFamilyTree();
        } else {
            renderPersonList();
        }
        populateSelectOptions();
    }
    
    function renderFamilyTree() {
        if (!settings.rootPersonId) {
            treeContainer.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="currentColor">起点となる人物を設定してください</text>`;
            return;
        }

        const rootPerson = findPersonById(settings.rootPersonId);
        if (!rootPerson) {
            treeContainer.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="currentColor">起点となる人物が見つかりません</text>`;
            return;
        }

        const { nodes, links, bounds } = buildTreeLayout(rootPerson);
        treeContainer.innerHTML = '';

        links.forEach(link => {
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', link.d);
            path.setAttribute('fill', 'none');
            path.setAttribute('stroke', 'rgb(156 163 175)');
            path.setAttribute('stroke-width', '2');
            treeContainer.appendChild(path);
        });

        const selectedCategory = categoryFilter.value;
        nodes.forEach(node => {
            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.classList.add('node');
            g.setAttribute('transform', `translate(${node.x}, ${node.y})`);
            g.dataset.id = node.id;
            g.addEventListener('click', () => openPersonModal(node.id));

            const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
            foreignObject.setAttribute('width', nodeSize.width);
            foreignObject.setAttribute('height', nodeSize.height);
            
            const age = calculateAge(node.person.birthdate, node.person.deathdate);
            const borderColor = node.person.isDeceased ? 'border-slate-400' : 'border-[var(--accent-color)]';
            const highlightClass = (selectedCategory === 'all' || node.person.familyCategory === selectedCategory) ? '' : 'opacity-20';
            const avatarSrc = node.person.photoUrl || generateAvatar(node.person);

            foreignObject.innerHTML = `
                <div xmlns="http://www.w3.org/1999/xhtml" class="w-full h-full p-2 rounded-lg soft-shadow node-card bg-white dark:bg-slate-800 border-2 ${borderColor} flex items-center space-x-2 cursor-pointer ${highlightClass}">
                    <img src="${avatarSrc}" class="w-12 h-12 rounded-full object-cover shrink-0" alt="${node.person.name}の写真">
                    <div class="flex-1 overflow-hidden">
                        <p class="font-bold text-sm truncate">${node.person.name}</p>
                        <p class="text-xs text-slate-500 dark:text-slate-400">${node.person.isDeceased ? '故人' : age + '歳'}</p>
                        <p class="text-xs text-slate-400 dark:text-slate-500 truncate">${node.person.familyCategory || ''}</p>
                    </div>
                </div>
            `;
            g.appendChild(foreignObject);
            treeContainer.appendChild(g);
        });
        
        const treeWidth = bounds.maxX - bounds.minX + nodeSize.width;
        const treeHeight = bounds.maxY - bounds.minY + nodeSize.height;
        const padding = 50;
        
        const svgWidth = treeSvg.clientWidth;
        const svgHeight = treeSvg.clientHeight;

        if (treeWidth > 0 && treeHeight > 0 && svgWidth > 0 && svgHeight > 0) {
            const scaleX = svgWidth / (treeWidth + padding * 2);
            const scaleY = svgHeight / (treeHeight + padding * 2);
            const scale = Math.min(scaleX, scaleY, 1);
            const viewBoxW = svgWidth / scale;
            const viewBoxH = svgHeight / scale;
            const viewBoxX = bounds.minX - (viewBoxW - treeWidth) / 2;
            const viewBoxY = bounds.minY - (viewBoxH - treeHeight) / 2;
            treeSvg.setAttribute('viewBox', `${viewBoxX} ${viewBoxY} ${viewBoxW} ${viewBoxH}`);
        }
    }

    function renderPersonList(filter = '') {
        personListContainer.innerHTML = '';
        const filteredPeople = people
            .filter(p => p.name.toLowerCase().includes(filter.toLowerCase()))
            .sort((a,b) => new Date(a.birthdate) - new Date(b.birthdate));

        if (filteredPeople.length === 0) {
            personListContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">該当する人物が見つかりません。</p>`;
            return;
        }
        
        filteredPeople.forEach(person => {
            const age = calculateAge(person.birthdate, person.deathdate);
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg soft-shadow bg-white dark:bg-slate-800 flex flex-col`;
            card.dataset.id = person.id;
            const events = calculateEvents(person);
            const avatarSrc = person.photoUrl || generateAvatar(person);

            card.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${avatarSrc}" class="w-16 h-16 rounded-full object-cover cursor-pointer" alt="${person.name}の写真">
                    <div class="flex-1 cursor-pointer">
                        <div class="flex justify-between items-start">
                             <h3 class="font-bold text-lg">${person.name}</h3>
                             <span class="text-sm font-semibold ${person.isDeceased ? 'text-slate-400' : 'accent-text'}">${person.isDeceased ? '故人' : age + '歳'}</span>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400">${person.kana || ''}</p>
                    </div>
                     <button title="編集" class="edit-person-btn p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shrink-0">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"></path></svg>
                    </button>
                </div>
                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-300 space-y-1 flex-1 cursor-pointer">
                    <p><strong>誕生日:</strong> ${formatDateJP(person.birthdate)}</p>
                    <div class="max-h-24 overflow-y-auto space-y-1 pr-2">
                        ${events.map(e => `<p><strong>${e.name}:</strong> ${formatDateJP(e.date)}</p>`).join('')}
                    </div>
                </div>
            `;
            personListContainer.appendChild(card);
        });
    }

    // --- UI/VIEW LOGIC ---
    function switchView(view) {
        document.querySelectorAll('#view-toggle button').forEach(btn => {
            btn.classList.toggle('bg-slate-200', btn.dataset.view === view);
            btn.classList.toggle('dark:bg-slate-700', btn.dataset.view === view);
        });
        treeViewEl.classList.toggle('hidden', view !== 'tree');
        listViewEl.classList.toggle('hidden', view !== 'list');
        searchBox.classList.toggle('md:block', view === 'list');
        categoryFilterContainer.classList.toggle('hidden', view !== 'tree');
        categoryFilterContainer.classList.toggle('flex', view === 'tree');

        render();
    }
    
    function renderEventTimeline(person) {
        const timelineEl = document.getElementById('event-timeline');
        const events = calculateEvents(person);
        if(events.length === 0) {
            timelineEl.innerHTML = `<p class="text-slate-500">自動計算されるイベントはありません。</p>`;
            return;
        }

        timelineEl.innerHTML = events.map(event => `
            <div class="flex items-center">
                <div class="w-32 font-semibold">${formatDateJP(event.date)}</div>
                <div class="relative px-2">
                    <div class="h-full w-0.5 bg-slate-300 dark:bg-slate-600"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 h-2.5 w-2.5 rounded-full accent-bg border-2 border-white dark:border-slate-800"></div>
                </div>
                <div>${event.name} (${event.age}歳)</div>
            </div>
        `).join('');
    }

    // --- MODAL & FORM HANDLING ---
    function openPersonModal(personId = null) {
        personForm.reset();
        document.getElementById('death-date-container').classList.add('hidden');
        
        populateSelectOptions(personId);
        populateCategorySelect(document.getElementById('familyCategory'));
        
        if (personId) {
            const person = findPersonById(personId);
            if (person) {
                document.getElementById('id').value = person.id;
                document.getElementById('name').value = person.name;
                document.getElementById('kana').value = person.kana || '';
                createDateSelectors('birthdate-container', person.birthdate, true);
                document.getElementById('gender').value = person.gender || '不明';
                document.getElementById('fatherId').value = person.fatherId || '';
                document.getElementById('motherId').value = person.motherId || '';
                document.getElementById('spouseId').value = person.spouseId || '';
                document.getElementById('isDeceased').checked = person.isDeceased || false;
                if(person.isDeceased) {
                     createDateSelectors('deathdate-container-selectors', person.deathdate, false);
                     document.getElementById('death-date-container').classList.remove('hidden');
                } else {
                     createDateSelectors('deathdate-container-selectors', null, false);
                }
                document.getElementById('photoUrl').value = person.photoUrl || '';
                document.getElementById('photoPreview').src = person.photoUrl || generateAvatar(person);
                document.getElementById('familyCategory').value = person.familyCategory || '（未分類）';
                document.getElementById('address').value = person.address || '';
                document.getElementById('memo').value = person.memo || '';
                createDateSelectors('weddingDate-container', person.weddingDate, false);

                document.getElementById('delete-person-button').classList.remove('hidden');
                renderEventTimeline(person);
            }
        } else {
            document.getElementById('id').value = '';
            createDateSelectors('birthdate-container', null, true);
            createDateSelectors('deathdate-container-selectors', null, false);
            createDateSelectors('weddingDate-container', null, false);
            document.getElementById('delete-person-button').classList.add('hidden');
            document.getElementById('event-timeline').innerHTML = '';
            document.getElementById('photoPreview').src = generateAvatar({name: '?'});
        }
        personModal.classList.add('flex');
        personModal.classList.remove('hidden');
    }

    function handleFormSubmit(e) {
        e.preventDefault();
        const id = document.getElementById('id').value;
        
        const birthdate = getDateFromSelectors('birthdate-container');
        if (!birthdate) {
            alert('生年月日を正しく入力してください。');
            return;
        }

        const personData = {
            id: id || crypto.randomUUID(),
            name: document.getElementById('name').value,
            kana: document.getElementById('kana').value,
            birthdate: birthdate,
            gender: document.getElementById('gender').value,
            fatherId: document.getElementById('fatherId').value || null,
            motherId: document.getElementById('motherId').value || null,
            spouseId: document.getElementById('spouseId').value || null,
            isDeceased: document.getElementById('isDeceased').checked,
            deathdate: document.getElementById('isDeceased').checked ? getDateFromSelectors('deathdate-container-selectors') : null,
            photoUrl: document.getElementById('photoUrl').value || null,
            familyCategory: document.getElementById('familyCategory').value,
            address: document.getElementById('address').value,
            memo: document.getElementById('memo').value,
            weddingDate: getDateFromSelectors('weddingDate-container'),
        };
        
        if (id) {
            const index = people.findIndex(p => p.id === id);
            if (index !== -1) people[index] = { ...people[index], ...personData };
        } else {
            people.push(personData);
        }
        
        if (personData.spouseId) {
            const spouse = findPersonById(personData.spouseId);
            if (spouse && (spouse.spouseId !== personData.id || spouse.weddingDate !== personData.weddingDate)) {
                const spouseIndex = people.findIndex(p => p.id === spouse.id);
                if (spouseIndex !== -1) {
                    people[spouseIndex].spouseId = personData.id;
                    if(personData.weddingDate) people[spouseIndex].weddingDate = personData.weddingDate;
                }
            }
        }

        saveData();
        render();
        closePersonModal();
    }
    
    // --- CATEGORY MANAGEMENT ---
    function renderCategoryManager() {
        const container = document.getElementById('category-list');
        container.innerHTML = familyCategories.map(cat => `
            <div class="flex justify-between items-center bg-slate-100 dark:bg-slate-700 p-2 rounded-md">
                <span>${cat}</span>
                ${cat !== '（未分類）' ? `<button data-category="${cat}" class="text-red-500 hover:text-red-700 text-lg">&times;</button>` : ''}
            </div>
        `).join('');
    }

    function addCategory() {
        const input = document.getElementById('new-category-input');
        const newCategory = input.value.trim();
        if (newCategory && !familyCategories.includes(newCategory)) {
            familyCategories.push(newCategory);
            saveData();
            renderCategoryManager();
            input.value = '';
        }
    }

    function handleDeleteCategory(e) {
        if (e.target.tagName === 'BUTTON') {
            const categoryToDelete = e.target.dataset.category;
            if (categoryToDelete && categoryToDelete !== '（未分類）') {
                if(confirm(`「${categoryToDelete}」を削除しますか？このカテゴリーの人物は「（未分類）」に移動します。`)){
                    familyCategories = familyCategories.filter(c => c !== categoryToDelete);
                    people.forEach(p => {
                        if (p.familyCategory === categoryToDelete) p.familyCategory = '（未分類）';
                    });
                    saveData();
                    renderCategoryManager();
                }
            }
        }
    }
    
    // --- UTILITIES ---
    function findPersonById(id) { return people.find(p => p.id === id); }
    
    function calculateEvents(person) {
        if (!person.birthdate) return [];
        const birth = new Date(person.birthdate);
        let events = [];
        const eventDefs = [
            { name: '小学校卒業', age: 12, month: 3, day: 31 },
            { name: '中学校卒業', age: 15, month: 3, day: 31 },
            { name: '高校卒業', age: 18, month: 3, day: 31 },
            { name: '大学卒業', age: 22, month: 3, day: 31 },
            { name: '成人', age: 18, month: birth.getMonth()+1, day: birth.getDate() },
            { name: '還暦', age: 60, month: birth.getMonth()+1, day: birth.getDate() },
        ];
        
        eventDefs.forEach(def => {
            let eventDate = (def.month && def.day) 
                ? new Date(birth.getFullYear() + def.age, def.month - 1, def.day)
                : new Date(birth.getFullYear() + def.age, birth.getMonth(), birth.getDate());
            if (eventDate <= new Date()) events.push({ date: eventDate.toISOString().split('T')[0], name: def.name, age: def.age });
        });

        if (person.weddingDate) {
            events.push({ date: person.weddingDate, name: '結婚記念日', age: calculateAge(person.birthdate, person.weddingDate) });
        }
        
        if (person.isDeceased && person.deathdate) {
            const deathDate = new Date(person.deathdate + 'T00:00:00');
            events.push({ date: person.deathdate, name: '命日', age: calculateAge(person.birthdate, person.deathdate) });

            const memorials = [
                { name: '一周忌', years: 1 }, { name: '三回忌', years: 2 },
                { name: '七回忌', years: 6 }, { name: '十三回忌', years: 12 },
                { name: '十七回忌', years: 16 }, { name: '二十三回忌', years: 22 },
                { name: '三十三回忌', years: 32 }, { name: '五十回忌', years: 49 },
            ];
            
            memorials.forEach(memorial => {
                const memorialDate = new Date(deathDate);
                memorialDate.setFullYear(deathDate.getFullYear() + memorial.years);
                if (memorialDate <= new Date()) {
                     events.push({
                        date: memorialDate.toISOString().split('T')[0],
                        name: memorial.name,
                        age: calculateAge(person.birthdate, memorialDate.toISOString().split('T')[0])
                    });
                }
            });
        }


        return events.sort((a,b) => new Date(a.date) - new Date(b.date));
    }
    
    function formatDateJP(isoDate) {
        if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return '';
        const date = new Date(isoDate + 'T00:00:00'); // Avoid timezone issues
        const year = date.getFullYear();
        const month = date.getMonth() + 1;
        const day = date.getDate();
        return `${year}年${month}月${day}日`;
    }

    function generateAvatar(person) {
        const name = person.name || '?';
        const initial = name.charAt(0).toUpperCase();
        
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
        }
        
        const colors = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#4ade80', '#34d399', '#2dd4bf', '#22d3ee', '#38bdf8', '#60a5fa', '#818cf8', '#a78bfa', '#c084fc', '#e879f9', '#f472b6'];
        let color;

        if (person.gender === '男性') {
            color = colors[Math.abs(hash) % 7 + 8]; // Blues/Purples
        } else if (person.gender === '女性') {
            color = colors[Math.abs(hash) % 7]; // Reds/Oranges/Pinks
        } else {
            color = colors[Math.abs(hash) % colors.length];
        }

        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <rect width="100" height="100" fill="${color}" />
                <text x="50" y="55" font-family="Noto Sans JP, sans-serif" font-size="50" fill="white" text-anchor="middle" dominant-baseline="middle">${initial}</text>
            </svg>
        `;
        return `data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(svg)))}`;
    }

    function handlePhotoFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            document.getElementById('photoUrl').value = e.target.result;
            document.getElementById('photoPreview').src = e.target.result;
        };
        reader.readAsDataURL(file);
        event.target.value = null;
    }
    
    function createDateSelectors(containerId, initialDate, isRequired) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';

        const yearSelect = document.createElement('select');
        const monthSelect = document.createElement('select');
        const daySelect = document.createElement('select');

        yearSelect.innerHTML = `<option value="">年</option>`;
        monthSelect.innerHTML = `<option value="">月</option>`;
        daySelect.innerHTML = `<option value="">日</option>`;

        const currentYear = new Date().getFullYear();
        for (let y = currentYear + 5; y >= 1900; y--) {
            yearSelect.innerHTML += `<option value="${y}">${y}</option>`;
        }
        for (let m = 1; m <= 12; m++) {
            monthSelect.innerHTML += `<option value="${m}">${m}</option>`;
        }

        container.append(yearSelect, monthSelect, daySelect);

        const updateDays = () => {
            const year = parseInt(yearSelect.value);
            const month = parseInt(monthSelect.value);
            const currentDay = daySelect.value;
            daySelect.innerHTML = `<option value="">日</option>`;
            if (year && month) {
                const daysInMonth = new Date(year, month, 0).getDate();
                for (let d = 1; d <= daysInMonth; d++) {
                    daySelect.innerHTML += `<option value="${d}">${d}</option>`;
                }
                daySelect.value = currentDay;
            }
        };

        yearSelect.addEventListener('change', updateDays);
        monthSelect.addEventListener('change', updateDays);

        if (initialDate && /^\d{4}-\d{2}-\d{2}$/.test(initialDate)) {
            const [year, month, day] = initialDate.split('-').map(Number);
            yearSelect.value = year;
            monthSelect.value = month;
            updateDays();
            daySelect.value = day;
        }
    }

    function getDateFromSelectors(containerId) {
        const container = document.getElementById(containerId);
        const [year, month, day] = Array.from(container.querySelectorAll('select')).map(s => s.value);
        if (year && month && day) {
            return `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        }
        return null;
    }

    function populateSelectOptions(currentPersonId = null) {
        const selects = ['fatherId', 'motherId', 'spouseId', 'rootPersonId'];
        const sortedPeople = [...people].sort((a, b) => (a.kana || a.name).localeCompare(b.kana || b.name, 'ja'));
        selects.forEach(id => {
            const select = document.getElementById(id);
            if (!select) return;
            const currentValue = select.value;
            select.innerHTML = '<option value="">未選択</option>';
            sortedPeople.forEach(p => {
                if (id !== 'rootPersonId' && p.id === currentPersonId) return;
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = p.name;
                select.appendChild(option);
            });
            select.value = currentValue;
        });
    }

    function populateCategorySelect(selectElement) {
        const currentValue = selectElement.value;
        selectElement.innerHTML = '';
        familyCategories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            selectElement.appendChild(option);
        });
        selectElement.value = currentValue || '（未分類）';
    }

    function renderCategoryFilter() {
        const currentValue = categoryFilter.value;
        categoryFilter.innerHTML = '<option value="all">すべてのカテゴリー</option>';
        familyCategories.forEach(cat => {
            if (cat === '（未分類）') return;
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            categoryFilter.appendChild(option);
        });
        categoryFilter.value = currentValue;
    }
    
    function closePersonModal() { personModal.classList.add('hidden'); personModal.classList.remove('flex'); }
    function openSettingsModal() { renderCategoryManager(); document.getElementById('rootPersonId').value = settings.rootPersonId; settingsModal.classList.add('flex'); settingsModal.classList.remove('hidden'); }
    function closeSettingsModal() { settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); }
    function applyTheme() { document.documentElement.classList.toggle('dark', settings.theme === 'dark'); }
    function applySettings() {
        applyTheme();
        document.getElementById('rootPersonId').value = settings.rootPersonId;
        const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`);
        if (themeRadio) themeRadio.checked = true;
    }
    function handleDeletePerson() {
        const id = document.getElementById('id').value;
        if (!id || !confirm('この人物を本当に削除しますか？関連する情報も更新されます。')) return;
        people = people.filter(p => p.id !== id);
        people.forEach(p => {
            if (p.fatherId === id) p.fatherId = null;
            if (p.motherId === id) p.motherId = null;
            if (p.spouseId === id) p.spouseId = null;
        });
        if (settings.rootPersonId === id) {
            settings.rootPersonId = people.length > 0 ? people[0].id : null;
        }
        saveData();
        render();
        closePersonModal();
    }
     function getChildren(personId) { return people.filter(p => p.fatherId === personId || p.motherId === personId); }
     function calculateAge(birthdate, deathdate = null) {
        if (!birthdate) return '?';
        const birth = new Date(birthdate);
        const end = deathdate ? new Date(deathdate) : new Date();
        let age = end.getFullYear() - birth.getFullYear();
        const m = end.getMonth() - birth.getMonth();
        if (m < 0 || (m === 0 && end.getDate() < birth.getDate())) { age--; }
        return Math.max(0, age);
    }
    function buildTreeLayout(rootPerson) {
        let nodes = [], links = [], positions = {}, generationLevels = {}, bounds = { minX: 0, maxX: 0, minY: 0, maxY: 0 }, visited = new Set();
        function traverse(person, level) {
            if (!person || visited.has(person.id)) return;
            visited.add(person.id);
            if (!generationLevels[level]) generationLevels[level] = [];
            if (!generationLevels[level].includes(person.id)) generationLevels[level].push(person.id);
            if(person.fatherId) traverse(findPersonById(person.fatherId), level - 1);
            if(person.motherId) traverse(findPersonById(person.motherId), level - 1);
            if(person.spouseId) traverse(findPersonById(person.spouseId), level);
            getChildren(person.id).forEach(child => traverse(child, level + 1));
        }
        traverse(rootPerson, 0);
        const validLevels = Object.keys(generationLevels).map(Number).filter(isFinite);
        if (validLevels.length === 0) return { nodes, links, bounds };
        const minLevel = Math.min(...validLevels);
        Object.keys(generationLevels).sort((a,b) => a-b).forEach(level => {
            const y = (level - minLevel) * (nodeSize.height + nodeGap.y);
            const levelNodes = generationLevels[level];
            let x = - (levelNodes.length * (nodeSize.width + nodeGap.x) - nodeGap.x) / 2;
            levelNodes.forEach(id => { if (!positions[id]) positions[id] = { x, y }; x += nodeSize.width + nodeGap.x; });
        });
        const drawnLinks = new Set();
        visited.forEach(id => {
            const person = findPersonById(id), pos = positions[id];
            if (!person || !pos) return;
            nodes.push({ id: person.id, person, x: pos.x, y: pos.y });
            bounds.minX = Math.min(bounds.minX, pos.x); bounds.maxX = Math.max(bounds.maxX, pos.x);
            bounds.minY = Math.min(bounds.minY, pos.y); bounds.maxY = Math.max(bounds.maxY, pos.y);
            if(person.spouseId && positions[person.spouseId] && person.id < person.spouseId) {
                const spousePos = positions[person.spouseId];
                if (Math.abs(pos.y - spousePos.y) < nodeGap.y / 2) links.push({d: `M ${pos.x + nodeSize.width} ${pos.y + nodeSize.height / 2} H ${spousePos.x}`});
            }
            const children = getChildren(person.id);
            if (children.length > 0) {
                const coupleKey = person.spouseId ? [person.id, person.spouseId].sort().join('-') : id;
                if (!drawnLinks.has(coupleKey)) {
                    const childrenPos = children.map(c => positions[c.id]).filter(Boolean);
                    if (childrenPos.length > 0) {
                        let startX = pos.x + nodeSize.width / 2;
                        if (person.spouseId && positions[person.spouseId] && Math.abs(pos.y - positions[person.spouseId].y) < nodeGap.y / 2) {
                           startX = (pos.x + positions[person.spouseId].x) / 2 + nodeSize.width / 2;
                        }
                         const startY = pos.y + nodeSize.height, midY = startY + nodeGap.y / 2;
                         links.push({ d: `M ${startX} ${startY} V ${midY}` });
                         const minChildX = Math.min(...childrenPos.map(p => p.x)), maxChildX = Math.max(...childrenPos.map(p => p.x));
                         links.push({ d: `M ${minChildX + nodeSize.width/2} ${midY} H ${maxChildX + nodeSize.width/2}`});
                         childrenPos.forEach(childPos => links.push({ d: `M ${childPos.x + nodeSize.width / 2} ${midY} V ${childPos.y}` }));
                         drawnLinks.add(coupleKey);
                    }
                }
            }
        });
        return { nodes, links: Array.from(new Map(links.map(l => [l.d, l])).values()), bounds };
    }
     function exportJSON() { alert('Not implemented in this version'); } function importJSON(event) { alert('Not implemented in this version'); }
     function exportCSV() { alert('Not implemented in this version'); } function importCSV(event) { alert('Not implemented in this version'); }

    // --- SAMPLE DATA (Updated) ---
    function getSampleData() {
        const p1 = { id: crypto.randomUUID(), name: '高橋 正雄', kana: 'タカハシ マサオ', birthdate: '1935-04-10', gender: '男性', isDeceased: true, deathdate: '2015-10-20', fatherId: null, motherId: null, spouseId: null, photoUrl: null, familyCategory: '高橋家', memo: '初代。厳格だった。', weddingDate: '1960-05-15', address: '東京都渋谷区' };
        const p2 = { id: crypto.randomUUID(), name: '高橋 和子', kana: 'タカハシ カズコ', birthdate: '1938-08-25', gender: '女性', isDeceased: false, deathdate: null, fatherId: null, motherId: null, spouseId: p1.id, photoUrl: null, familyCategory: '高橋家', memo: '料理上手。', weddingDate: '1960-05-15', address: '東京都渋谷区' };
        p1.spouseId = p2.id;
        
        const p3 = { id: crypto.randomUUID(), name: '佐藤 健一', kana: 'サトウ ケンイチ', birthdate: '1933-01-15', gender: '男性', isDeceased: true, deathdate: '2010-05-18', fatherId: null, motherId: null, spouseId: null, photoUrl: null, familyCategory: '佐藤家', memo: '', weddingDate: null, address: '' };
        const p4 = { id: crypto.randomUUID(), name: '佐藤 良子', kana: 'サトウ ヨシコ', birthdate: '1936-11-03', gender: '女性', isDeceased: true, deathdate: '2018-01-02', fatherId: null, motherId: null, spouseId: p3.id, photoUrl: null, familyCategory: '佐藤家', memo: '', weddingDate: null, address: '' };
        p3.spouseId = p4.id;

        const p5 = { id: crypto.randomUUID(), name: '高橋 太郎', kana: 'タカハシ タロウ', birthdate: '1965-05-20', gender: '男性', isDeceased: false, deathdate: null, fatherId: p1.id, motherId: p2.id, spouseId: null, photoUrl: null, familyCategory: '高橋家', memo: '釣りが趣味。', weddingDate: '1994-06-10', address: '神奈川県横浜市' };
        const p6 = { id: crypto.randomUUID(), name: '高橋 (佐藤) 京子', kana: 'タカハシ (サトウ) キョウコ', birthdate: '1968-07-30', gender: '女性', isDeceased: false, deathdate: null, fatherId: p3.id, motherId: p4.id, spouseId: p5.id, photoUrl: null, familyCategory: '高橋家', memo: '旧姓は佐藤。', weddingDate: '1994-06-10', address: '神奈川県横浜市' };
        p5.spouseId = p6.id;

        const p7 = { id: crypto.randomUUID(), name: '高橋 誠', kana: 'タカハシ マコト', birthdate: '1995-09-01', gender: '男性', isDeceased: false, deathdate: null, fatherId: p5.id, motherId: p6.id, spouseId: null, photoUrl: null, familyCategory: '高橋家', memo: 'ITエンジニア。', weddingDate: '2022-11-22', address: '東京都新宿区' };
        const p8 = { id: crypto.randomUUID(), name: '高橋 (鈴木) 裕子', kana: 'タカハシ (スズキ) ユウコ', birthdate: '1996-02-14', gender: '女性', isDeceased: false, deathdate: null, fatherId: null, motherId: null, spouseId: p7.id, photoUrl: null, familyCategory: '高橋家', memo: '旧姓は鈴木。', weddingDate: '2022-11-22', address: '東京都新宿区' };
        p7.spouseId = p8.id;

        const p9 = { id: crypto.randomUUID(), name: '高橋 美咲', kana: 'タカハシ ミサキ', birthdate: '1998-12-10', gender: '女性', isDeceased: false, deathdate: null, fatherId: p5.id, motherId: p6.id, spouseId: null, photoUrl: null, familyCategory: '高橋家', memo: '海外旅行が好き。', weddingDate: null, address: '神奈川県横浜市' };
        
        const p10 = { id: crypto.randomUUID(), name: '高橋 健太', kana: 'タカハシ ケンタ', birthdate: '2025-01-15', gender: '男性', isDeceased: false, deathdate: null, fatherId: p7.id, motherId: p8.id, spouseId: null, photoUrl: null, familyCategory: '高橋家', memo: '', weddingDate: null, address: '東京都新宿区' };

        return [p1, p2, p3, p4, p5, p6, p7, p8, p9, p10];
    }
    
    init();
});
</script>
</body>
</html>

