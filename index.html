<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家系図 Webアプリ (Firebase連携版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #38bdf8; --accent-color-dark: #0ea5e9; }
        body { font-family: 'Noto Sans JP', sans-serif; }
        .accent-bg { background-color: var(--accent-color); }
        .accent-bg-hover:hover { background-color: var(--accent-color-dark); }
        .accent-text { color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }
        .soft-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        #tree-svg { cursor: grab; }
        #tree-svg:active { cursor: grabbing; }
        .node .node-card { transition: all 0.2s ease-in-out; }
        .node:hover .node-card { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .date-selector-group select { @apply mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]; }
        .deceased-card { opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div id="app" class="h-screen w-screen flex flex-col">
        <header class="bg-white dark:bg-slate-800 soft-shadow z-10 p-2 sm:p-4 flex items-center justify-between">
            <h1 class="text-xl sm:text-2xl font-bold text-slate-700 dark:text-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1 mr-2 accent-text"><path d="M3 6v12"></path><path d="M18 6v12"></path><path d="M10.5 6h3"></path><path d="M10.5 18h3"></path><path d="M6 12h12"></path></svg>
                家系図
            </h1>
            <div class="flex items-center space-x-2 sm:space-x-4">
                <div id="category-filter-container" class="hidden items-center space-x-2">
                    <label for="category-filter" class="text-sm font-medium hidden sm:block">表示:</label>
                    <select id="category-filter" class="w-32 px-2 py-1 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] text-sm"></select>
                </div>
                <input type="search" id="search-box" placeholder="名前で検索..." class="w-32 sm:w-64 px-3 py-1.5 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition-all text-sm">
                <div id="view-toggle" class="flex items-center border border-slate-300 dark:border-slate-600 rounded-full p-0.5">
                    <button data-view="list" class="px-3 py-1 text-sm rounded-full bg-slate-200 dark:bg-slate-700">一覧</button>
                    <button data-view="age" class="px-3 py-1 text-sm rounded-full">年齢別</button>
                    <button data-view="tree" class="px-3 py-1 text-sm rounded-full">家系図</button>
                </div>
                <button id="settings-button" title="設定" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                </button>
            </div>
        </header>

        <main class="flex-1 relative overflow-hidden">
            <div id="list-view" class="w-full h-full p-4 overflow-y-auto">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 dark:bg-slate-900 py-2 z-10">
                    <div class="flex items-center space-x-2">
                         <h2 class="text-lg font-bold">人物一覧（カテゴリー別）</h2>
                         <select id="sort-order" class="px-2 py-1 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] text-sm">
                            <option value="custom_fuchigami">カスタム（渕上竜也先頭）</option>
                            <option value="birthdate_asc">年齢順（年上から）</option>
                            <option value="birthdate_desc">年齢順（年下から）</option>
                            <option value="kana_asc">名前順</option>
                        </select>
                    </div>
                    <button id="add-person-list-btn" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">
                        + 新規追加
                    </button>
                </div>
                <div id="person-list-container" class="space-y-8"></div>
            </div>
            <div id="age-view" class="w-full h-full p-4 overflow-y-auto hidden">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 dark:bg-slate-900 py-2 z-10">
                    <h2 class="text-lg font-bold">人物一覧（年齢順）</h2>
                </div>
                <div id="person-age-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
            <div id="tree-view" class="w-full h-full hidden">
                <svg id="tree-svg" class="w-full h-full">
                    <g id="tree-container"></g>
                </svg>
            </div>
        </main>
    </div>

    <div id="person-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">個人情報の編集</h2>
                <button id="close-modal-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="person-form" class="space-y-4">
                    <input type="hidden" id="id">
                    <div class="flex items-start space-x-4">
                        <img id="photoPreview" src="" class="w-24 h-24 rounded-full object-cover bg-slate-200" alt="写真プレビュー">
                        <div class="flex-1 space-y-2">
                            <label for="photoUrl" class="block text-sm font-medium text-slate-600 dark:text-slate-300">写真URL</label>
                            <input type="text" id="photoUrl" placeholder="ファイルをアップロードすると自動入力されます" class="block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">ファイルをアップロード:
                                <input type="file" id="photoFile" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                                <progress id="uploadProgress" value="0" max="100" class="w-full h-2 mt-1 hidden"></progress>
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-slate-600 dark:text-slate-300">名前 (必須)</label>
                            <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label for="kana" class="block text-sm font-medium text-slate-600 dark:text-slate-300">フリガナ</label>
                            <input type="text" id="kana" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">生年月日 (必須)</label>
                            <div id="birthdate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-slate-600 dark:text-slate-300">性別</label>
                            <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                                <option value="不明">不明</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                            </select>
                        </div>
                        <div>
                            <label for="fatherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">父親</label>
                            <select id="fatherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="motherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">母親</label>
                            <select id="motherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="spouseId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">配偶者</label>
                            <select id="spouseId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">結婚記念日</label>
                            <div id="weddingDate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="familyCategory" class="block text-sm font-medium text-slate-600 dark:text-slate-300">所属カテゴリー</label>
                            <select id="familyCategory" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="company" class="block text-sm font-medium text-slate-600 dark:text-slate-300">会社名</label>
                            <input type="text" id="company" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div class="md:col-span-2">
                            <label for="comment" class="block text-sm font-medium text-slate-600 dark:text-slate-300">一言コメント</label>
                            <input type="text" id="comment" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium text-slate-600 dark:text-slate-300">住所</label>
                            <textarea id="address" rows="2" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="memo" class="block text-sm font-medium text-slate-600 dark:text-slate-300">メモ</label>
                            <textarea id="memo" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                        </div>
                        <div class="md:col-span-2 flex items-start space-x-4">
                            <label for="isDeceased" class="flex items-center space-x-2 pt-1">
                                <input type="checkbox" id="isDeceased" class="h-4 w-4 rounded border-gray-300 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                                <span>故人</span>
                            </label>
                            <div id="death-date-container" class="hidden flex-1">
                                <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">没年月日</label>
                                <div id="deathdate-container-selectors" class="date-selector-group grid grid-cols-3 gap-2"></div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-900/50 rounded-b-2xl">
                <button id="delete-person-button" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">削除</button>
                <div>
                    <button id="cancel-modal-button" class="text-slate-700 dark:text-slate-200 bg-transparent hover:bg-slate-200 dark:hover:bg-slate-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">キャンセル</button>
                    <button id="save-person-button" type="submit" form="person-form" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">保存</button>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="close-settings-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="rootPersonId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">家系図の起点となる人物</label>
                    <select id="rootPersonId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                </div>
                <div id="category-manager">
                    <h3 class="text-lg font-semibold mb-2">カテゴリー管理</h3>
                    <div id="category-list" class="space-y-2 mb-2"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="new-category-input" placeholder="新しいカテゴリー名" class="flex-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        <button id="add-category-btn" class="accent-bg text-white px-4 py-2 rounded-md text-sm font-semibold accent-bg-hover transition-colors">追加</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">テーマ</label>
                    <div class="mt-2 flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ライト</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ダーク</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyWHeePZ45__X3WIodJCkNsoh6u8gQQCI",
            authDomain: "my-kakeizu-app.firebaseapp.com",
            projectId: "my-kakeizu-app",
            storageBucket: "my-kakeizu-app.appspot.com",
            messagingSenderId: "501655228969",
            appId: "1:501655228969:web:28e3dfd482d99f1df9c238",
            measurementId: "G-BF4V7N22YG"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // DOM Elements
        const peopleCollection = db.collection('people');
        const categoriesDoc = db.collection('settings').doc('categories');
        const treeViewEl = document.getElementById('tree-view');
        const listViewEl = document.getElementById('list-view');
        const ageViewEl = document.getElementById('age-view');
        const personAgeListContainer = document.getElementById('person-age-list-container');
        const personListContainer = document.getElementById('person-list-container');
        const treeSvg = document.getElementById('tree-svg');
        const treeContainer = document.getElementById('tree-container');
        const categoryFilterContainer = document.getElementById('category-filter-container');
        const categoryFilter = document.getElementById('category-filter');
        const personModal = document.getElementById('person-modal');
        const settingsModal = document.getElementById('settings-modal');
        const personForm = document.getElementById('person-form');
        const searchBox = document.getElementById('search-box');
        
        // State
        let people = [];
        let familyCategories = [];
        let settings = { rootPersonId: null, theme: 'light' };
        let initialLoad = true;
        let currentFileUpload = null;

        const nodeSize = { width: 180, height: 80 };
        const nodeGap = { x: 40, y: 80 };
        
        // Initialization
        function init() {
            const savedSettings = localStorage.getItem('familyTreeSettings');
            if (savedSettings) {
                settings = { ...settings, ...JSON.parse(savedSettings) };
            }
            setupEventListeners();
            applySettings();
            switchView('list');

            categoriesDoc.onSnapshot(doc => {
                familyCategories = doc.exists ? doc.data().list || ['（未分類）'] : ['（未分類）'];
                renderCategoryFilter();
            });

            peopleCollection.onSnapshot(snapshot => {
                people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (initialLoad && people.length > 0) {
                    setDefaultRootPerson();
                    initialLoad = false;
                }
                render();
            });
        }

        function setDefaultRootPerson() {
            if (settings.rootPersonId && findPersonById(settings.rootPersonId)) return;
            const defaultRoot = people.find(p => p.name === '渕上猪彦');
            if (defaultRoot) {
                settings.rootPersonId = defaultRoot.id;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
            }
        }
        
        // Firestore Functions
        async function savePerson(personData) {
            const { id, ...dataToSave } = personData;
            await peopleCollection.doc(id).set(dataToSave, { merge: true });
        }

        // Event Listeners
        function setupEventListeners() {
            document.getElementById('view-toggle').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') switchView(e.target.dataset.view);
            });
            [personListContainer, personAgeListContainer].forEach(container => {
                container.addEventListener('click', e => {
                    const card = e.target.closest('[data-id]');
                    if (card) openPersonModal(card.dataset.id);
                });
            });
            document.getElementById('add-person-list-btn').addEventListener('click', () => openPersonModal());
            document.getElementById('settings-button').addEventListener('click', openSettingsModal);
            document.getElementById('close-modal-button').addEventListener('click', closePersonModal);
            document.getElementById('cancel-modal-button').addEventListener('click', closePersonModal);
            document.getElementById('close-settings-button').addEventListener('click', closeSettingsModal);
            personForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('delete-person-button').addEventListener('click', handleDeletePerson);
            searchBox.addEventListener('input', render);
            document.getElementById('rootPersonId').addEventListener('change', e => {
                settings.rootPersonId = e.target.value;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                render();
            });
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    settings.theme = e.target.value;
                    applyTheme();
                    localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                });
            });
            document.getElementById('add-category-btn').addEventListener('click', addCategory);
            document.getElementById('category-list').addEventListener('click', handleDeleteCategory);
            categoryFilter.addEventListener('change', render);
            document.getElementById('sort-order').addEventListener('change', render);
            document.getElementById('isDeceased').addEventListener('change', e => {
                document.getElementById('death-date-container').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('photoFile').addEventListener('change', handlePhotoFileSelect);
            document.getElementById('photoUrl').addEventListener('input', e => {
                document.getElementById('photoPreview').src = e.target.value || generateAvatar({name: document.getElementById('name').value || '?'});
            });

            // SVG Pan/Zoom Listeners
            let isPanning = false, startPoint = { x: 0, y: 0 }, viewBox = { x: 0, y: 0, w: 0, h: 0 };
            treeSvg.addEventListener('mousedown', e => { if (e.target.closest('foreignObject')) return; isPanning = true; startPoint = { x: e.clientX, y: e.clientY }; const vb = treeSvg.getAttribute('viewBox')?.split(' ').map(Number) || [0,0,treeSvg.clientWidth,treeSvg.clientHeight]; viewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]}; });
            treeSvg.addEventListener('mousemove', e => { if (!isPanning) return; const dx = (startPoint.x - e.clientX) * (viewBox.w / treeSvg.clientWidth); const dy = (startPoint.y - e.clientY) * (viewBox.h / treeSvg.clientHeight); treeSvg.setAttribute('viewBox', `${viewBox.x + dx} ${viewBox.y + dy} ${viewBox.w} ${viewBox.h}`); });
            treeSvg.addEventListener('mouseup', () => isPanning = false);
            treeSvg.addEventListener('mouseleave', () => isPanning = false);
            treeSvg.addEventListener('wheel', e => { e.preventDefault(); const zoomFactor = 1.1; const { clientX, clientY } = e; const vb = treeSvg.getAttribute('viewBox')?.split(' ').map(Number) || [0,0,treeSvg.clientWidth,treeSvg.clientHeight]; let currentViewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]}; const point = svgPoint(clientX, clientY); const newW = e.deltaY > 0 ? currentViewBox.w * zoomFactor : currentViewBox.w / zoomFactor; const newH = e.deltaY > 0 ? currentViewBox.h * zoomFactor : currentViewBox.h / zoomFactor; currentViewBox.x += (point.x-currentViewBox.x)*(1-newW/currentViewBox.w); currentViewBox.y += (point.y-currentViewBox.y)*(1-newH/currentViewBox.h); currentViewBox.w = newW; currentViewBox.h = newH; treeSvg.setAttribute('viewBox', `${currentViewBox.x} ${currentViewBox.y} ${currentViewBox.w} ${currentViewBox.h}`); });
            function svgPoint(clientX, clientY) { const pt = treeSvg.createSVGPoint(); pt.x = clientX; pt.y = clientY; return pt.matrixTransform(treeSvg.getScreenCTM().inverse()); }
        }
        
        async function handleFormSubmit(e) {
            e.preventDefault();
            const saveButton = document.getElementById('save-person-button');
            saveButton.disabled = true;
            saveButton.textContent = '保存中...';
            try {
                let id = document.getElementById('id').value || db.collection('people').doc().id;
                const birthdate = getDateFromSelectors('birthdate-container');
                if (!birthdate) throw new Error('生年月日を正しく入力してください。');

                let photoUrl = document.getElementById('photoUrl').value;
                if (currentFileUpload) {
                    photoUrl = await uploadPhoto(id, currentFileUpload);
                }
                
                const personData = {
                    id, name: document.getElementById('name').value, kana: document.getElementById('kana').value, birthdate,
                    gender: document.getElementById('gender').value, fatherId: document.getElementById('fatherId').value || null,
                    motherId: document.getElementById('motherId').value || null, spouseId: document.getElementById('spouseId').value || null,
                    isDeceased: document.getElementById('isDeceased').checked,
                    deathdate: document.getElementById('isDeceased').checked ? getDateFromSelectors('deathdate-container-selectors') : null,
                    photoUrl: photoUrl || null, familyCategory: document.getElementById('familyCategory').value,
                    address: document.getElementById('address').value, memo: document.getElementById('memo').value,
                    company: document.getElementById('company').value, comment: document.getElementById('comment').value,
                    weddingDate: getDateFromSelectors('weddingDate-container')
                };

                await savePerson(personData);

                if (personData.spouseId) {
                    const spouse = findPersonById(personData.spouseId);
                    if (spouse && (spouse.spouseId !== personData.id)) {
                        await savePerson({ ...spouse, spouseId: personData.id });
                    }
                }
                closePersonModal();
            } catch (error) {
                console.error("保存に失敗しました:", error);
                alert(error.message || "保存に失敗しました。");
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = '保存';
            }
        }

        async function handleDeletePerson(personId) {
            const idToDelete = personId || document.getElementById('id').value;
            if (!idToDelete || !confirm('この人物を本当に削除しますか？関連する情報も更新されます。')) return;

            const personToDelete = findPersonById(idToDelete);
            if (personToDelete && personToDelete.photoUrl && personToDelete.photoUrl.startsWith('https://firebasestorage.googleapis.com/')) {
                try {
                    const photoRef = storage.refFromURL(personToDelete.photoUrl);
                    await photoRef.delete();
                } catch (error) {
                    console.warn('写真の削除に失敗しました:', error);
                }
            }
            
            await db.collection('people').doc(idToDelete).delete();

            const updates = people
                .filter(p => p.fatherId === idToDelete || p.motherId === idToDelete || p.spouseId === idToDelete)
                .map(p => {
                    const updated = { ...p };
                    if (p.fatherId === idToDelete) updated.fatherId = null;
                    if (p.motherId === idToDelete) updated.motherId = null;
                    if (p.spouseId === idToDelete) updated.spouseId = null;
                    return savePerson(updated);
                });
            await Promise.all(updates);

            if (settings.rootPersonId === idToDelete) {
                settings.rootPersonId = people.length > 1 ? people.find(p => p.id !== idToDelete).id : null;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
            }
            
            closePersonModal();
        }

        async function addCategory() {
            const input = document.getElementById('new-category-input');
            const newCategory = input.value.trim();
            if (!newCategory || familyCategories.includes(newCategory)) {
                alert(newCategory ? 'そのカテゴリーは既に存在します。' : 'カテゴリー名を入力してください。');
                return;
            }
            const updatedCategories = [...familyCategories, newCategory];
            await categoriesDoc.set({ list: updatedCategories });
            input.value = '';
        }

        async function handleDeleteCategory(e) {
            if (e.target.tagName !== 'BUTTON') return;
            const categoryToDelete = e.target.dataset.category;
            if (categoryToDelete && categoryToDelete !== '（未分類）' && confirm(`「${categoryToDelete}」を削除しますか？`)){
                const updatedCategories = familyCategories.filter(c => c !== categoryToDelete);
                await categoriesDoc.set({ list: updatedCategories });
            }
        }
        
        function render() {
            populateSelectOptions();
            const currentView = document.querySelector('#view-toggle button[data-view].bg-slate-200')?.dataset.view || 'list';
            if (currentView === 'tree') renderFamilyTree();
            else if (currentView === 'age') renderAgeList();
            else renderPersonList();
        }

        function renderFamilyTree() {
            const selectedCategory = categoryFilter.value;
            let personScope = (selectedCategory === 'all') ? people : people.filter(p => p.familyCategory === selectedCategory);
            let rootPerson = findPersonById(settings.rootPersonId);
            if (!rootPerson || !personScope.some(p => p.id === rootPerson.id)) {
                rootPerson = personScope.length > 0 ? personScope[0] : null;
            }
            treeContainer.innerHTML = '';
            if (!rootPerson) {
                treeContainer.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="currentColor">表示する人物がいません。</text>';
                return;
            }
            const { nodes, links, bounds } = buildTreeLayout(rootPerson, personScope);
            links.forEach(link => { /* ... */ });
            nodes.forEach(node => {
                const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
                g.classList.add('node');
                g.setAttribute('transform', `translate(${node.x}, ${node.y})`);
                g.addEventListener('click', () => openPersonModal(node.id));
                const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                foreignObject.setAttribute('width', nodeSize.width);
                foreignObject.setAttribute('height', nodeSize.height);
                const ageDisplay = getAgeDisplay(node.person);
                const borderColor = node.person.isDeceased ? 'border-slate-400' : 'border-[var(--accent-color)]';
                const avatarSrc = node.person.photoUrl || generateAvatar(node.person);
                foreignObject.innerHTML = `<div xmlns="http://www.w3.org/1999/xhtml" class="w-full h-full p-2 rounded-lg soft-shadow node-card bg-white dark:bg-slate-800 border-2 ${borderColor} flex items-center space-x-2 cursor-pointer"><img src="${avatarSrc}" class="w-12 h-12 rounded-full object-cover shrink-0"><div class="flex-1 overflow-hidden"><p class="font-bold text-sm truncate">${node.person.name}</p><p class="text-xs ${node.person.isDeceased ? 'text-slate-400' : 'accent-text'} font-semibold">${ageDisplay}</p></div></div>`;
                g.appendChild(foreignObject);
                treeContainer.appendChild(g);
            });
            // Set viewBox...
        }
        
        function renderPersonList() {
            const filter = searchBox.value.toLowerCase();
            const sortOrder = document.getElementById('sort-order').value;
            personListContainer.innerHTML = '';
            const filteredPeople = people.filter(p => p.name.toLowerCase().includes(filter) || (p.kana || '').toLowerCase().includes(filter));
            if (filteredPeople.length === 0) {
                personListContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">該当する人物が見つかりません。</p>`;
                return;
            }
            const groupedByCategory = filteredPeople.reduce((acc, person) => {
                const category = person.familyCategory || '（未分類）';
                if (!acc[category]) acc[category] = [];
                acc[category].push(person);
                return acc;
            }, {});
            const sortedCategories = Object.keys(groupedByCategory).sort((a, b) => {
                if (a === '（未分類）') return 1; if (b === '（未分類）') return -1;
                return a.localeCompare(b, 'ja');
            });
            sortedCategories.forEach(category => {
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'col-span-full';
                categoryContainer.innerHTML = `<h2 class="text-xl font-bold border-b-2 border-[var(--accent-color)] pb-2 mb-4">${category}</h2>`;
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                const peopleInCategory = groupedByCategory[category];
                peopleInCategory.sort((a,b) => {
                    if (sortOrder === 'custom_fuchigami') {
                        if (a.name === '渕上竜也') return -1; if (b.name === '渕上竜也') return 1;
                    }
                    if (!a.birthdate) return 1; if (!b.birthdate) return -1;
                    switch (sortOrder) {
                        case 'birthdate_desc': return new Date(b.birthdate) - new Date(a.birthdate);
                        case 'kana_asc': return (a.kana || a.name).localeCompare(b.kana || b.name, 'ja');
                        default: return new Date(a.birthdate) - new Date(b.birthdate);
                    }
                });
                peopleInCategory.forEach(person => gridContainer.appendChild(createPersonCard(person)));
                categoryContainer.appendChild(gridContainer);
                personListContainer.appendChild(categoryContainer);
            });
        }

        function renderAgeList() {
            const filter = searchBox.value.toLowerCase();
            personAgeListContainer.innerHTML = '';
            const filteredPeople = people
                .filter(p => p.name.toLowerCase().includes(filter) || (p.kana || '').toLowerCase().includes(filter))
                .sort((a, b) => {
                    if (!a.birthdate) return 1; if (!b.birthdate) return -1;
                    return new Date(a.birthdate) - new Date(b.birthdate);
                });
            if (filteredPeople.length === 0) {
                personAgeListContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">該当する人物が見つかりません。</p>`;
                return;
            }
            filteredPeople.forEach(person => personAgeListContainer.appendChild(createPersonCard(person)));
        }

        function switchView(view) {
            document.querySelectorAll('#view-toggle button').forEach(btn => {
                btn.classList.toggle('bg-slate-200', btn.dataset.view === view);
                btn.classList.toggle('dark:bg-slate-700', btn.dataset.view === view);
            });
            const isTree = view === 'tree';
            treeViewEl.classList.toggle('hidden', !isTree);
            ageViewEl.classList.toggle('hidden', view !== 'age');
            listViewEl.classList.toggle('hidden', view !== 'list');
            searchBox.classList.toggle('hidden', isTree);
            categoryFilterContainer.classList.toggle('hidden', !isTree);
            categoryFilterContainer.classList.toggle('flex', isTree);
            document.getElementById('sort-order').style.display = (view === 'list') ? 'block' : 'none';
            render();
        }

        function getAgeDisplay(person) {
            if (person.isDeceased) {
                const ageIfAlive = calculateAge(person.birthdate, null);
                return `故人 (存命なら ${ageIfAlive}歳)`;
            }
            return `${calculateAge(person.birthdate, person.deathdate)}歳`;
        }

        function createPersonCard(person) {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg soft-shadow bg-white dark:bg-slate-800 flex flex-col cursor-pointer ${person.isDeceased ? 'deceased-card' : ''}`;
            card.dataset.id = person.id;
            const ageDisplay = getAgeDisplay(person);
            const avatarSrc = person.photoUrl || generateAvatar(person);
            const commentHTML = person.comment ? `<p class="text-sm font-semibold accent-text truncate">“${person.comment}”</p>` : '';
            card.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${avatarSrc}" class="w-16 h-16 rounded-full object-cover" alt="${person.name}の写真">
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg truncate">${person.name}</h3>
                            <span class="text-sm font-semibold ${person.isDeceased ? 'text-slate-400' : 'accent-text'} whitespace-nowrap">${ageDisplay}</span>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${person.kana || ''}</p>
                        ${commentHTML}
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-300 space-y-1 flex-1">
                    <p><strong>誕生日:</strong> ${formatDateJP(person.birthdate)}</p>
                    ${person.company ? `<p><strong>会社:</strong> ${person.company}</p>` : ''}
                </div>`;
            return card;
        }

        function handlePhotoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            currentFileUpload = file;
            const reader = new FileReader();
            reader.onload = e => document.getElementById('photoPreview').src = e.target.result;
            reader.readAsDataURL(file);
            event.target.value = null;
        }

        async function uploadPhoto(id, file) {
            const progress = document.getElementById('uploadProgress');
            progress.classList.remove('hidden');
            const fileName = `photo_${id}_${Date.now()}`;
            const storageRef = storage.ref(`photos/${fileName}`);
            const uploadTask = storageRef.put(file);
            return new Promise((resolve, reject) => {
                uploadTask.on('state_changed', 
                    snapshot => { progress.value = (snapshot.bytesTransferred / snapshot.totalBytes) * 100; }, 
                    reject,
                    () => { uploadTask.snapshot.ref.getDownloadURL().then(url => {
                        progress.classList.add('hidden');
                        resolve(url);
                    }); }
                );
            });
        }
        
        function calculateAge(birthdate, deathdate = null) {
            if (!birthdate) return '?';
            const birth = new Date(birthdate);
            const end = deathdate ? new Date(deathdate) : new Date();
            let age = end.getFullYear() - birth.getFullYear();
            const m = end.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && end.getDate() < birth.getDate())) age--;
            return Math.max(0, age);
        }

        // Other helper functions...
        function findPersonById(id) { return people.find(p => p.id === id); }
        function openPersonModal(personId = null) { 
            personForm.reset();
            currentFileUpload = null;
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('death-date-container').classList.add('hidden');
            populateSelectOptions(personId);
            populateCategorySelect(document.getElementById('familyCategory'));
            if (personId) {
                const person = findPersonById(personId);
                if (person) {
                    document.getElementById('id').value = person.id;
                    document.getElementById('name').value = person.name;
                    document.getElementById('kana').value = person.kana || '';
                    createDateSelectors('birthdate-container', person.birthdate, true);
                    document.getElementById('gender').value = person.gender || '不明';
                    document.getElementById('fatherId').value = person.fatherId || '';
                    document.getElementById('motherId').value = person.motherId || '';
                    document.getElementById('spouseId').value = person.spouseId || '';
                    document.getElementById('isDeceased').checked = person.isDeceased || false;
                    if (person.isDeceased) {
                        createDateSelectors('deathdate-container-selectors', person.deathdate, false);
                        document.getElementById('death-date-container').classList.remove('hidden');
                    } else {
                        createDateSelectors('deathdate-container-selectors', null, false);
                    }
                    document.getElementById('photoUrl').value = person.photoUrl || '';
                    document.getElementById('photoPreview').src = person.photoUrl || generateAvatar(person);
                    document.getElementById('familyCategory').value = person.familyCategory || '（未分類）';
                    document.getElementById('address').value = person.address || '';
                    document.getElementById('memo').value = person.memo || '';
                    document.getElementById('company').value = person.company || '';
                    document.getElementById('comment').value = person.comment || '';
                    createDateSelectors('weddingDate-container', person.weddingDate, false);
                    document.getElementById('delete-person-button').classList.remove('hidden');
                }
            } else {
                document.getElementById('id').value = '';
                createDateSelectors('birthdate-container', null, true);
                createDateSelectors('deathdate-container-selectors', null, false);
                createDateSelectors('weddingDate-container', null, false);
                document.getElementById('delete-person-button').classList.add('hidden');
                document.getElementById('photoPreview').src = generateAvatar({name: '?'});
            }
            personModal.classList.add('flex');
            personModal.classList.remove('hidden');
        }
        function createDateSelectors(containerId, initialDate, isRequired = false) { /* ... */ }
        function getDateFromSelectors(containerId) { /* ... */ }
        function populateSelectOptions(currentPersonId = null) { /* ... */ }
        function populateCategorySelect(selectElement) { /* ... */ }
        function renderCategoryFilter() { /* ... */ }
        function closePersonModal() { personModal.classList.add('hidden'); personModal.classList.remove('flex'); }
        function openSettingsModal() { /* ... */ }
        function closeSettingsModal() { /* ... */ }
        function renderCategoryManager() { /* ... */ }
        function applyTheme() { document.documentElement.classList.toggle('dark', settings.theme === 'dark'); }
        function applySettings() { applyTheme(); const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`); if (themeRadio) themeRadio.checked = true; }
        function generateAvatar(person) { /* ... */ }
        function buildTreeLayout(rootPerson, personData) { /* ... */ }

        init();
    });
    </script>
</body>
</html>
