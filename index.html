<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家系図 Webアプリ (Firebase連携版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent-color: #38bdf8; --accent-color-dark: #0ea5e9; }
        body { font-family: 'Noto Sans JP', sans-serif; }
        .accent-bg { background-color: var(--accent-color); }
        .accent-bg-hover:hover { background-color: var(--accent-color-dark); }
        .accent-text { color: var(--accent-color); }
        .accent-border { border-color: var(--accent-color); }
        .soft-shadow { box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .modal-backdrop { background-color: rgba(0, 0, 0, 0.5); }
        #tree-svg { cursor: grab; }
        #tree-svg:active { cursor: grabbing; }
        .node .node-card { transition: all 0.2s ease-in-out; }
        .node:hover .node-card { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .date-selector-group select { @apply mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]; }
        
        /* Category Icon Styles */
        .category-icon {
            @apply w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold cursor-pointer transition-all duration-200 ease-in-out soft-shadow;
            background-color: #e0f2fe; /* Light blue default */
            color: #0c4a6e; /* Dark blue text */
            border: 2px solid transparent;
        }
        .category-icon.selected {
            @apply ring-2 ring-[var(--accent-color)] ring-offset-2;
            background-color: var(--accent-color);
            color: white;
            transform: scale(1.1);
        }
        .category-icon:hover:not(.selected) {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 10px -2px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .dark .category-icon {
            background-color: #1e293b; /* Dark slate */
            color: #94a3b8; /* Light slate text */
        }
        .dark .category-icon.selected {
            background-color: var(--accent-color);
            color: white;
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <div id="app" class="h-screen w-screen flex flex-col">
        <header class="bg-white dark:bg-slate-800 soft-shadow z-10 p-2 sm:p-4 flex flex-col">
            <div class="relative w-full h-20 sm:h-28 overflow-hidden rounded-lg mb-4 soft-shadow">
                <img src="https://firebasestorage.googleapis.com/v0/b/my-kakeizu-app.appspot.com/o/banners%2Ffamily-banner.jpg?alt=media&token=YOUR_IMAGE_TOKEN" 
                     alt="Family Tree Banner" 
                     class="absolute inset-0 w-full h-full object-cover opacity-70">
                <div class="absolute inset-0 bg-gradient-to-r from-blue-600/70 to-purple-600/70 dark:from-blue-800/70 dark:to-purple-800/70 mix-blend-multiply"></div>
                <div class="relative z-10 flex items-center h-full px-4 sm:px-8">
                    <svg xmlns="http://www.w3.org/2000/svg" width="36" height="36" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block mr-3 text-white"><path d="M3 6v12"></path><path d="M18 6v12"></path><path d="M10.5 6h3"></path><path d="M10.5 18h3"></path><path d="M6 12h12"></path></svg>
                    <h1 class="text-2xl sm:text-4xl font-extrabold text-white tracking-tight drop-shadow-lg">
                        家系図
                    </h1>
                </div>
            </div>
            
            <div class="flex items-center justify-between w-full">
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <div id="category-icon-filter-container" class="flex space-x-2 overflow-x-auto pb-1">
                        </div>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4 ml-auto">
                    <input type="search" id="search-box" placeholder="名前で検索..." class="w-32 sm:w-64 px-3 py-1.5 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-[var(--accent-color)] transition-all text-sm">
                    <div id="view-toggle" class="flex items-center border border-slate-300 dark:border-slate-600 rounded-full p-0.5">
                        <button data-view="list" class="px-3 py-1 text-sm rounded-full bg-slate-200 dark:bg-slate-700">一覧</button>
                        <button data-view="age" class="px-3 py-1 text-sm rounded-full">年齢順</button>
                        <button data-view="tree" class="px-3 py-1 text-sm rounded-full">家系図</button>
                    </div>
                    <button id="settings-button" title="設定" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
                    </button>
                </div>
            </div>
        </header>

        <main class="flex-1 relative overflow-hidden">
            <div id="list-view" class="w-full h-full p-4 overflow-y-auto">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 dark:bg-slate-900 py-2 z-10">
                    <div class="flex items-center space-x-2">
                         <h2 class="text-lg font-bold">人物一覧（カテゴリー別）</h2>
                         <select id="sort-order" class="px-2 py-1 border border-slate-300 dark:border-slate-600 rounded-full bg-slate-100 dark:bg-slate-700 focus:outline-none focus:ring-1 focus:ring-[var(--accent-color)] text-sm">
                            <option value="custom_fuchigami">カスタム（渕上竜也先頭）</option>
                            <option value="birthdate_asc">年齢順（年上から）</option>
                            <option value="birthdate_desc">年齢順（年下から）</option>
                            <option value="kana_asc">名前順</option>
                        </select>
                    </div>
                    <button id="add-person-list-btn" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">
                        + 新規追加
                    </button>
                </div>
                <div id="person-list-container" class="space-y-8"></div>
            </div>
            <div id="age-view" class="w-full h-full p-4 overflow-y-auto hidden">
                <div class="flex justify-between items-center mb-4 sticky top-0 bg-slate-50 dark:bg-slate-900 py-2 z-10">
                    <h2 class="text-lg font-bold">人物一覧（年齢順）</h2>
                </div>
                <div id="person-age-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
            </div>
            <div id="tree-view" class="w-full h-full hidden">
                <svg id="tree-svg" class="w-full h-full">
                    <g id="tree-container"></g>
                </svg>
            </div>
        </main>
    </div>

    <div id="person-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">個人情報の編集</h2>
                <button id="close-modal-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="flex-1 overflow-y-auto p-6">
                <form id="person-form" class="space-y-4">
                    <input type="hidden" id="id">
                    <div class="flex items-start space-x-4">
                        <img id="photoPreview" src="" class="w-24 h-24 rounded-full object-cover bg-slate-200" alt="写真プレビュー">
                        <div class="flex-1 space-y-2">
                            <label for="photoUrl" class="block text-sm font-medium text-slate-600 dark:text-slate-300">写真URL</label>
                            <input type="text" id="photoUrl" placeholder="URLを直接入力、またはファイルアップロード" class="block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                            <label class="block text-sm font-medium text-slate-700 dark:text-slate-300">ファイルをアップロード:
                                <input type="file" id="photoFile" accept="image/*" class="mt-1 block w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-sky-50 file:text-sky-700 hover:file:bg-sky-100">
                                <progress id="uploadProgress" value="0" max="100" class="w-full h-2 mt-1 hidden"></progress>
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="name" class="block text-sm font-medium text-slate-600 dark:text-slate-300">名前 (必須)</label>
                            <input type="text" id="name" required class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label for="kana" class="block text-sm font-medium text-slate-600 dark:text-slate-300">フリガナ</label>
                            <input type="text" id="kana" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">生年月日 (必須)</label>
                            <div id="birthdate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                        <div>
                            <label for="gender" class="block text-sm font-medium text-slate-600 dark:text-slate-300">性別</label>
                            <select id="gender" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                                <option value="不明">不明</option>
                                <option value="男性">男性</option>
                                <option value="女性">女性</option>
                            </select>
                        </div>
                        <div>
                            <label for="fatherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">父親</label>
                            <select id="fatherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="motherId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">母親</label>
                            <select id="motherId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label for="spouseId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">配偶者</label>
                            <select id="spouseId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">結婚記念日</label>
                            <div id="weddingDate-container" class="date-selector-group grid grid-cols-3 gap-2"></div>
                        </div>
                        <div class="md:col-span-2">
                            <label for="familyCategory" class="block text-sm font-medium text-slate-600 dark:text-slate-300">所属カテゴリー</label>
                            <select id="familyCategory" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                        </div>
                        <div class="md:col-span-2">
                            <label for="company" class="block text-sm font-medium text-slate-600 dark:text-slate-300">会社名</label>
                            <input type="text" id="company" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div class="md:col-span-2">
                            <label for="comment" class="block text-sm font-medium text-slate-600 dark:text-slate-300">一言コメント</label>
                            <input type="text" id="comment" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        </div>
                        <div class="md:col-span-2">
                            <label for="address" class="block text-sm font-medium text-slate-600 dark:text-slate-300">住所</label>
                            <textarea id="address" rows="2" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <label for="memo" class="block text-sm font-medium text-slate-600 dark:text-slate-300">メモ</label>
                            <textarea id="memo" rows="3" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></textarea>
                        </div>
                        <div class="md:col-span-2 flex items-start space-x-4">
                            <label for="isDeceased" class="flex items-center space-x-2 pt-1">
                                <input type="checkbox" id="isDeceased" class="h-4 w-4 rounded border-gray-300 text-[var(--accent-color)] focus:ring-[var(--accent-color)]">
                                <span>故人</span>
                            </label>
                            <div id="death-date-container" class="hidden flex-1">
                                <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">没年月日</label>
                                <div id="deathdate-container-selectors" class="date-selector-group grid grid-cols-3 gap-2"></div>
                            </div>
                        </div>
                    </div>
                    <div class="pt-4">
                        <h3 class="text-lg font-semibold mb-2">イベントタイムライン</h3>
                        <div id="event-timeline" class="space-y-2 text-sm"></div>
                    </div>
                </form>
            </div>
            <div class="flex justify-between items-center p-4 bg-slate-50 dark:bg-slate-900/50 rounded-b-2xl">
                <button id="delete-person-button" class="text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">削除</button>
                <div>
                    <button id="cancel-modal-button" class="text-slate-700 dark:text-slate-200 bg-transparent hover:bg-slate-200 dark:hover:bg-slate-700 px-4 py-2 rounded-full text-sm font-semibold transition-colors">キャンセル</button>
                    <button id="save-person-button" type="submit" form="person-form" class="accent-bg text-white px-4 py-2 rounded-full text-sm font-semibold accent-bg-hover transition-colors">保存</button>
                </div>
            </div>
        </div>
    </div>
    <div id="settings-modal" class="fixed inset-0 z-50 items-center justify-center hidden p-4 modal-backdrop">
        <div class="bg-white dark:bg-slate-800 rounded-2xl soft-shadow w-full max-w-lg">
            <div class="flex justify-between items-center p-4 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-xl font-bold">設定</h2>
                <button id="close-settings-button" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700">&times;</button>
            </div>
            <div class="p-6 space-y-6">
                <div>
                    <label for="rootPersonId" class="block text-sm font-medium text-slate-600 dark:text-slate-300">家系図の起点となる人物</label>
                    <select id="rootPersonId" class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]"></select>
                </div>
                <div id="category-manager">
                    <h3 class="text-lg font-semibold mb-2">カテゴリー管理</h3>
                    <div id="category-list" class="space-y-2 mb-2"></div>
                    <div class="flex space-x-2">
                        <input type="text" id="new-category-input" placeholder="新しいカテゴリー名" class="flex-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)]">
                        <button id="add-category-btn" class="accent-bg text-white px-4 py-2 rounded-md text-sm font-semibold accent-bg-hover transition-colors">追加</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-600 dark:text-slate-300">テーマ</label>
                    <div class="mt-2 flex items-center space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="theme" value="light" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ライト</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="theme" value="dark" class="form-radio h-4 w-4 text-[var(--accent-color)]">
                            <span class="ml-2 text-sm">ダーク</span>
                        </label>
                    </div>
                </div>
                <div class="border-t border-slate-200 dark:border-slate-700 pt-6">
                    <h3 class="text-lg font-semibold mb-2">データ管理 (未実装)</h3>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button disabled class="flex-1 text-slate-400 dark:text-slate-500 bg-slate-200 dark:bg-slate-700 px-4 py-2 rounded-full text-sm font-semibold cursor-not-allowed">JSONインポート</button>
                        <button disabled class="flex-1 text-white/50 bg-sky-300 dark:bg-sky-800 px-4 py-2 rounded-full text-sm font-semibold cursor-not-allowed">JSONエクスポート</button>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-2 mt-2">
                        <button disabled class="flex-1 text-slate-400 dark:text-slate-500 bg-slate-200 dark:bg-slate-700 px-4 py-2 rounded-full text-sm font-semibold cursor-not-allowed">CSVインポート</button>
                        <button disabled class="flex-1 text-white/50 bg-sky-300 dark:bg-sky-800 px-4 py-2 rounded-full text-sm font-semibold cursor-not-allowed">CSVエクスポート</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-storage.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAyWHeePZ45__X3WIodJCkNsoh6u8gQQCI",
            authDomain: "my-kakeizu-app.firebaseapp.com",
            projectId: "my-kakeizu-app",
            storageBucket: "my-kakeizu-app.appspot.com",
            messagingSenderId: "501655228969",
            appId: "1:501655228969:web:28e3dfd482d99f1df9c238",
            measurementId: "G-BF4V7N22YG"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();
        const storage = firebase.storage();
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const peopleCollection = db.collection('people');
        const categoriesDoc = db.collection('settings').doc('categories');

        let people = [];
        let familyCategories = [];
        let settings = { rootPersonId: null, theme: 'light', selectedCategoryFilter: 'all' }; // Added selectedCategoryFilter
        let initialLoad = true;

        const savedSettings = localStorage.getItem('familyTreeSettings');
        if (savedSettings) {
            settings = JSON.parse(savedSettings);
        }

        const treeViewEl = document.getElementById('tree-view');
        const listViewEl = document.getElementById('list-view');
        const ageViewEl = document.getElementById('age-view');
        const personAgeListContainer = document.getElementById('person-age-list-container');
        const personListContainer = document.getElementById('person-list-container');
        const treeSvg = document.getElementById('tree-svg');
        const treeContainer = document.getElementById('tree-container');
        const categoryFilterContainer = document.getElementById('category-icon-filter-container'); // Changed to new icon container
        const personModal = document.getElementById('person-modal');
        const settingsModal = document.getElementById('settings-modal');
        const personForm = document.getElementById('person-form');
        const searchBox = document.getElementById('search-box');
        
        const nodeSize = { width: 200, height: 90 };
        const nodeGap = { x: 40, y: 80 };

        function init() {
            setupEventListeners();
            applySettings();
            switchView('list');

            categoriesDoc.onSnapshot(doc => {
                // Ensure '（未分類）' is always present and at the start
                const fetchedCategories = doc.exists ? doc.data().list || [] : [];
                familyCategories = ['（未分類）', ...new Set(fetchedCategories.filter(c => c !== '（未分類）'))];
                renderCategoryIconFilter(); // Render category icons
                render();
            });

            peopleCollection.onSnapshot(snapshot => {
                people = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (initialLoad) {
                    setDefaultRootPerson();
                    initialLoad = false;
                }
                
                render();
            });
        }
        
        function setDefaultRootPerson() {
            if (settings.rootPersonId && findPersonById(settings.rootPersonId)) {
                return;
            }
            const defaultRoot = people.find(p => p.name === '渕上猪彦');
            if (defaultRoot) {
                settings.rootPersonId = defaultRoot.id;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
            }
        }

        async function savePerson(personData) {
            const { id, ...dataToSave } = personData;
            if (id) {
                await peopleCollection.doc(id).set(dataToSave, { merge: true });
            }
        }

        function setupEventListeners() {
            document.getElementById('view-toggle').addEventListener('click', e => {
                if (e.target.tagName === 'BUTTON') switchView(e.target.dataset.view);
            });
            [personListContainer, personAgeListContainer].forEach(container => {
                container.addEventListener('click', e => {
                    const card = e.target.closest('[data-id]');
                    if (card) openPersonModal(card.dataset.id);
                });
            });
            document.getElementById('add-person-list-btn').addEventListener('click', () => openPersonModal());
            document.getElementById('settings-button').addEventListener('click', openSettingsModal);
            document.getElementById('close-modal-button').addEventListener('click', closePersonModal);
            document.getElementById('cancel-modal-button').addEventListener('click', closePersonModal);
            document.getElementById('close-settings-button').addEventListener('click', closeSettingsModal);
            personForm.addEventListener('submit', handleFormSubmit);
            document.getElementById('delete-person-button').addEventListener('click', handleDeletePerson);
            searchBox.addEventListener('input', render);
            document.getElementById('rootPersonId').addEventListener('change', e => {
                settings.rootPersonId = e.target.value;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                render();
            });
            document.querySelectorAll('input[name="theme"]').forEach(radio => {
                radio.addEventListener('change', e => {
                    settings.theme = e.target.value;
                    applyTheme();
                    localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                });
            });
            document.getElementById('add-category-btn').addEventListener('click', addCategory);
            document.getElementById('category-list').addEventListener('click', handleDeleteCategory);
            document.getElementById('sort-order').addEventListener('change', render);
            document.getElementById('isDeceased').addEventListener('change', e => {
                document.getElementById('death-date-container').classList.toggle('hidden', !e.target.checked);
            });
            document.getElementById('photoFile').addEventListener('change', handlePhotoFileSelect);
            document.getElementById('photoUrl').addEventListener('input', e => {
                document.getElementById('photoPreview').src = e.target.value || generateAvatar({name: document.getElementById('name').value || '?'});
            });
            categoryFilterContainer.addEventListener('click', e => {
                const icon = e.target.closest('.category-icon');
                if (icon) {
                    settings.selectedCategoryFilter = icon.dataset.category || 'all';
                    localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                    renderCategoryIconFilter(); // Update selected state
                    render(); // Re-render tree with new filter
                }
            });

            let isPanning = false, startPoint = { x: 0, y: 0 }, viewBox = { x: 0, y: 0, w: 0, h: 0 };
            treeSvg.addEventListener('mousedown', e => { if (e.target.closest('foreignObject')) return; isPanning = true; startPoint = { x: e.clientX, y: e.clientY }; const vb = treeSvg.getAttribute('viewBox')?.split(' ').map(Number) || [0,0,treeSvg.clientWidth,treeSvg.clientHeight]; viewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]}; });
            treeSvg.addEventListener('mousemove', e => { if (!isPanning) return; const dx = (startPoint.x - e.clientX) * (viewBox.w / treeSvg.clientWidth); const dy = (startPoint.y - e.clientY) * (viewBox.h / treeSvg.clientHeight); treeSvg.setAttribute('viewBox', `${viewBox.x + dx} ${viewBox.y + dy} ${viewBox.w} ${viewBox.h}`); });
            treeSvg.addEventListener('mouseup', () => isPanning = false);
            treeSvg.addEventListener('mouseleave', () => isPanning = false);
            treeSvg.addEventListener('wheel', e => { e.preventDefault(); const zoomFactor = 1.1; const { clientX, clientY } = e; const vb = treeSvg.getAttribute('viewBox')?.split(' ').map(Number) || [0,0,treeSvg.clientWidth,treeSvg.clientHeight]; let currentViewBox = {x: vb[0], y: vb[1], w: vb[2], h: vb[3]}; const point = svgPoint(clientX, clientY); const newW = e.deltaY > 0 ? currentViewBox.w * zoomFactor : currentViewBox.w / zoomFactor; const newH = e.deltaY > 0 ? currentViewBox.h * zoomFactor : currentViewBox.h / zoomFactor; currentViewBox.x += (point.x-currentViewBox.x)*(1-newW/currentViewBox.w); currentViewBox.y += (point.y-currentViewBox.y)*(1-newH/currentViewBox.h); currentViewBox.w = newW; currentViewBox.h = newH; treeSvg.setAttribute('viewBox', `${currentViewBox.x} ${currentViewBox.y} ${currentViewBox.w} ${currentViewBox.h}`); });
            function svgPoint(clientX, clientY) { const pt = treeSvg.createSVGPoint(); pt.x = clientX; pt.y = clientY; return pt.matrixTransform(treeSvg.getScreenCTM().inverse()); }
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const saveButton = document.getElementById('save-person-button');
            saveButton.disabled = true;
            saveButton.textContent = '保存中...';

            let id = document.getElementById('id').value;
            let isNewPerson = false;
            if (!id) {
                id = db.collection('people').doc().id; // Generate ID upfront
                isNewPerson = true;
            }
            
            const birthdate = getDateFromSelectors('birthdate-container');
            if (!birthdate) {
                alert('生年月日を正しく入力してください。');
                saveButton.disabled = false;
                saveButton.textContent = '保存';
                return;
            }

            let photoUrl = document.getElementById('photoUrl').value;
            
            const personData = {
                id,
                name: document.getElementById('name').value,
                kana: document.getElementById('kana').value,
                birthdate,
                gender: document.getElementById('gender').value,
                fatherId: document.getElementById('fatherId').value || null,
                motherId: document.getElementById('motherId').value || null,
                spouseId: document.getElementById('spouseId').value || null,
                isDeceased: document.getElementById('isDeceased').checked,
                deathdate: document.getElementById('isDeceased').checked ? getDateFromSelectors('deathdate-container-selectors') : null,
                photoUrl: photoUrl || null,
                familyCategory: document.getElementById('familyCategory').value,
                address: document.getElementById('address').value,
                memo: document.getElementById('memo').value,
                company: document.getElementById('company').value,
                comment: document.getElementById('comment').value,
                weddingDate: getDateFromSelectors('weddingDate-container')
            };
            
            await savePerson(personData);

            if (personData.spouseId) {
                const spouse = findPersonById(personData.spouseId);
                if (spouse && (spouse.spouseId !== personData.id || spouse.weddingDate !== personData.weddingDate)) {
                    await savePerson({ ...spouse, spouseId: personData.id, weddingDate: personData.weddingDate || spouse.weddingDate });
                }
            }
            
            saveButton.disabled = false;
            saveButton.textContent = '保存';
            closePersonModal();
        }

        async function handleDeletePerson() {
            const id = document.getElementById('id').value;
            if (!id || !confirm('この人物を本当に削除しますか？関連する情報も更新されます。')) return;

            // Delete photo from storage if exists
            const personToDelete = findPersonById(id);
            if (personToDelete && personToDelete.photoUrl && personToDelete.photoUrl.startsWith('https://firebasestorage.googleapis.com/')) {
                try {
                    const photoRef = storage.refFromURL(personToDelete.photoUrl);
                    await photoRef.delete();
                    console.log('Photo deleted from storage:', personToDelete.photoUrl);
                } catch (error) {
                    console.warn('Failed to delete photo from storage (may not exist or permission issue):', error);
                }
            }

            await db.collection('people').doc(id).delete();

            const updates = people
                .filter(p => p.fatherId === id || p.motherId === id || p.spouseId === id)
                .map(p => {
                    const updated = { ...p };
                    if (p.fatherId === id) updated.fatherId = null;
                    if (p.motherId === id) updated.motherId = null;
                    if (p.spouseId === id) updated.spouseId = null;
                    return savePerson(updated);
                });

            await Promise.all(updates);

            if (settings.rootPersonId === id) {
                const remainingPeople = people.filter(p => p.id !== id);
                settings.rootPersonId = remainingPeople.length > 0 ? remainingPeople[0].id : null;
                localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
            }
            
            closePersonModal();
        }

        async function addCategory() {
            const input = document.getElementById('new-category-input');
            const newCategory = input.value.trim();
            if (!newCategory || familyCategories.includes(newCategory)) {
                alert(newCategory ? 'そのカテゴリーは既に存在します。' : 'カテゴリー名を入力してください。');
                return;
            }
            familyCategories.push(newCategory);
            await categoriesDoc.set({ list: familyCategories });
            input.value = '';
            renderCategoryIconFilter(); // Re-render icons
        }

        async function handleDeleteCategory(e) {
            if (e.target.tagName !== 'BUTTON') return;
            const categoryToDelete = e.target.dataset.category;
            if (categoryToDelete && categoryToDelete !== '（未分類）' && confirm(`「${categoryToDelete}」を削除しますか？このカテゴリーの人物は「（未分類）」に移動します。`)){
                if (settings.selectedCategoryFilter === categoryToDelete) settings.selectedCategoryFilter = 'all';

                const updates = people
                    .filter(p => p.familyCategory === categoryToDelete)
                    .map(p => savePerson({ ...p, familyCategory: '（未分類）' }));
                await Promise.all(updates);
                
                familyCategories = familyCategories.filter(c => c !== categoryToDelete);
                await categoriesDoc.set({ list: familyCategories });
                renderCategoryIconFilter(); // Re-render icons
            }
        }
        
        function render() {
            populateSelectOptions();
            const currentView = document.querySelector('#view-toggle button[data-view].bg-slate-200')?.dataset.view || 'list';
            if (currentView === 'tree') renderFamilyTree();
            else if (currentView === 'age') renderAgeList();
            else renderPersonList();
        }

        function renderFamilyTree() {
            treeContainer.innerHTML = '';
            let filteredPeopleForTree = people;

            // Apply category filter if not 'all'
            if (settings.selectedCategoryFilter !== 'all') {
                filteredPeopleForTree = people.filter(p => p.familyCategory === settings.selectedCategoryFilter);
            }

            const rootPerson = findPersonById(settings.rootPersonId);
            if (!rootPerson || !filteredPeopleForTree.includes(rootPerson)) {
                // If root person is not found or not in filtered category, try to find another root.
                // Or display a message.
                if (filteredPeopleForTree.length > 0) {
                     settings.rootPersonId = filteredPeopleForTree[0].id; // Fallback to first filtered person
                     localStorage.setItem('familyTreeSettings', JSON.stringify(settings));
                     render(); // Re-render with new root
                     return;
                } else {
                    treeContainer.innerHTML = '<text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-size="20" fill="currentColor">表示する人物がいません。</text>';
                    treeSvg.setAttribute('viewBox', `0 0 ${treeSvg.clientWidth} ${treeSvg.clientHeight}`);
                    return;
                }
            }

            const { nodes, links, bounds } = buildTreeLayout(rootPerson, filteredPeopleForTree); // Pass filtered people
            
            // Adjust viewBox to center the tree
            const treeWidth = bounds.maxX - bounds.minX + nodeSize.width;
            const treeHeight = bounds.maxY - bounds.minY + nodeSize.height;
            const svgWidth = treeSvg.clientWidth;
            const svgHeight = treeSvg.clientHeight;

            let scale = Math.min(svgWidth / treeWidth, svgHeight / treeHeight) * 0.9;
            scale = Math.min(scale, 1.2); // Don't zoom in too much by default

            const centerX = bounds.minX + treeWidth / 2;
            const centerY = bounds.minY + treeHeight / 2;

            const viewBoxWidth = svgWidth / scale;
            const viewBoxHeight = svgHeight / scale;

            const viewBoxX = centerX - viewBoxWidth / 2;
            const viewBoxY = centerY - viewBoxHeight / 2;
            
            treeSvg.setAttribute('viewBox', `${viewBoxX} ${viewBoxY} ${viewBoxWidth} ${viewBoxHeight}`);
            
            links.forEach(link => {
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('d', link.d);
                path.setAttribute('stroke', 'currentColor');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('fill', 'none');
                path.setAttribute('class', 'text-slate-400 dark:text-slate-600');
                treeContainer.appendChild(path);
            });

            nodes.forEach(node => {
                const foreignObject = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                foreignObject.setAttribute('x', node.x);
                foreignObject.setAttribute('y', node.y);
                foreignObject.setAttribute('width', nodeSize.width);
                foreignObject.setAttribute('height', nodeSize.height);
                foreignObject.setAttribute('class', 'node');
                foreignObject.innerHTML = `
                    <div xmlns="http://www.w3.org/1999/xhtml" class="node-card bg-white dark:bg-slate-800 rounded-lg soft-shadow p-3 flex items-center space-x-2 h-full cursor-pointer" data-id="${node.person.id}">
                        <img src="${node.person.photoUrl || generateAvatar(node.person)}" class="w-12 h-12 rounded-full object-cover flex-shrink-0" alt="${node.person.name}の写真">
                        <div class="flex-1 overflow-hidden">
                            <p class="font-bold text-sm truncate">${node.person.name}</p>
                            <p class="text-xs text-slate-500 dark:text-slate-400 truncate">${node.person.kana || ''}</p>
                            <p class="text-xs ${node.person.isDeceased ? 'text-slate-400' : 'accent-text'} font-semibold">${getAgeDisplay(node.person)}</p>
                        </div>
                    </div>
                `;
                foreignObject.querySelector('.node-card').addEventListener('click', () => openPersonModal(node.person.id));
                treeContainer.appendChild(foreignObject);
            });
        }
        
        function renderPersonList() {
            const filter = searchBox.value.toLowerCase();
            const sortOrder = document.getElementById('sort-order').value;
            personListContainer.innerHTML = '';
            
            let filteredPeople = people.filter(p => p.name.toLowerCase().includes(filter) || (p.kana || '').toLowerCase().includes(filter));
            
            // Apply category filter if not 'all'
            if (settings.selectedCategoryFilter !== 'all') {
                filteredPeople = filteredPeople.filter(p => p.familyCategory === settings.selectedCategoryFilter);
            }

            if (filteredPeople.length === 0) {
                personListContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">該当する人物が見つかりません。</p>`;
                return;
            }

            const groupedByCategory = filteredPeople.reduce((acc, person) => {
                const category = person.familyCategory || '（未分類）';
                if (!acc[category]) acc[category] = [];
                acc[category].push(person);
                return acc;
            }, {});

            const sortedCategories = Object.keys(groupedByCategory).sort((a, b) => {
                if (a === '（未分類）') return 1;
                if (b === '（未分類）') return -1;
                return a.localeCompare(b, 'ja');
            });

            sortedCategories.forEach(category => {
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'col-span-full';
                categoryContainer.innerHTML = `<h2 class="text-xl font-bold border-b-2 border-[var(--accent-color)] pb-2 mb-4">${category}</h2>`;
                const gridContainer = document.createElement('div');
                gridContainer.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4';
                
                const peopleInCategory = groupedByCategory[category];
                peopleInCategory.sort((a,b) => {
                    if (sortOrder === 'custom_fuchigami') {
                        if (a.name === '渕上竜也') return -1;
                        if (b.name === '渕上竜也') return 1;
                    }
                    if (!a.birthdate) return 1;
                    if (!b.birthdate) return -1;
                    switch (sortOrder) {
                        case 'birthdate_desc': return new Date(b.birthdate) - new Date(a.birthdate);
                        case 'kana_asc': return (a.kana || a.name).localeCompare(b.kana || b.name, 'ja');
                        default: return new Date(a.birthdate) - new Date(b.birthdate);
                    }
                });

                peopleInCategory.forEach(person => {
                    gridContainer.appendChild(createPersonCard(person));
                });
                
                categoryContainer.appendChild(gridContainer);
                personListContainer.appendChild(categoryContainer);
            });
        }
        
        function renderAgeList() {
            const filter = searchBox.value.toLowerCase();
            personAgeListContainer.innerHTML = '';

            let filteredPeople = people
                .filter(p => p.name.toLowerCase().includes(filter) || (p.kana || '').toLowerCase().includes(filter));
            
            // Apply category filter if not 'all'
            if (settings.selectedCategoryFilter !== 'all') {
                filteredPeople = filteredPeople.filter(p => p.familyCategory === settings.selectedCategoryFilter);
            }

            filteredPeople.sort((a, b) => {
                    if (!a.birthdate) return 1;
                    if (!b.birthdate) return -1;
                    return new Date(a.birthdate) - new Date(b.birthdate);
                });

            if (filteredPeople.length === 0) {
                personAgeListContainer.innerHTML = `<p class="text-slate-500 col-span-full text-center">該当する人物が見つかりません。</p>`;
                return;
            }

            filteredPeople.forEach(person => {
                personAgeListContainer.appendChild(createPersonCard(person));
            });
        }

        function switchView(view) {
            document.querySelectorAll('#view-toggle button').forEach(btn => {
                btn.classList.toggle('bg-slate-200', btn.dataset.view === view);
                btn.classList.toggle('dark:bg-slate-700', btn.dataset.view === view);
            });
            
            const isTree = view === 'tree';
            treeViewEl.classList.toggle('hidden', !isTree);
            ageViewEl.classList.toggle('hidden', view !== 'age');
            listViewEl.classList.toggle('hidden', view !== 'list');
            
            searchBox.classList.toggle('hidden', isTree);
            categoryFilterContainer.classList.toggle('hidden', !isTree);
            categoryFilterContainer.classList.toggle('flex', isTree);
            
            render();
        }
        
        function openPersonModal(personId = null) {
            personForm.reset();
            document.getElementById('uploadProgress').classList.add('hidden');
            document.getElementById('death-date-container').classList.add('hidden');
            populateSelectOptions(personId);
            populateCategorySelect(document.getElementById('familyCategory'));

            if (personId) {
                const person = findPersonById(personId);
                if (person) {
                    document.getElementById('id').value = person.id;
                    document.getElementById('name').value = person.name;
                    document.getElementById('kana').value = person.kana || '';
                    createDateSelectors('birthdate-container', person.birthdate, true);
                    document.getElementById('gender').value = person.gender || '不明';
                    document.getElementById('fatherId').value = person.fatherId || '';
                    document.getElementById('motherId').value = person.motherId || '';
                    document.getElementById('spouseId').value = person.spouseId || '';
                    document.getElementById('isDeceased').checked = person.isDeceased || false;
                    if(person.isDeceased) {
                        createDateSelectors('deathdate-container-selectors', person.deathdate, false);
                        document.getElementById('death-date-container').classList.remove('hidden');
                    } else {
                        createDateSelectors('deathdate-container-selectors', null, false);
                    }
                    document.getElementById('photoUrl').value = person.photoUrl || '';
                    document.getElementById('photoPreview').src = person.photoUrl || generateAvatar(person);
                    document.getElementById('familyCategory').value = person.familyCategory || '（未分類）';
                    document.getElementById('address').value = person.address || '';
                    document.getElementById('memo').value = person.memo || '';
                    document.getElementById('company').value = person.company || '';
                    document.getElementById('comment').value = person.comment || '';
                    createDateSelectors('weddingDate-container', person.weddingDate, false);
                    document.getElementById('delete-person-button').classList.remove('hidden');
                    renderEventTimeline(person);
                }
            } else {
                document.getElementById('id').value = '';
                createDateSelectors('birthdate-container', null, true);
                createDateSelectors('deathdate-container-selectors', null, false);
                createDateSelectors('weddingDate-container', null, false);
                document.getElementById('delete-person-button').classList.add('hidden');
                document.getElementById('event-timeline').innerHTML = '';
                document.getElementById('photoPreview').src = generateAvatar({name: '?'});
            }
            personModal.classList.add('flex');
            personModal.classList.remove('hidden');
        }
        
        function findPersonById(id) { return people.find(p => p.id === id); }
        function calculateEvents(person, showAll = false) { /* ... function content remains the same */ }
        function formatDateJP(isoDate) { /* ... function content remains the same */ }
        function generateAvatar(person) { /* ... function content remains the same */ }
        
        function handlePhotoFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const id = document.getElementById('id').value || db.collection('people').doc().id;
            document.getElementById('id').value = id; // Make sure new persons have an ID if not already set

            const fileName = `photo_${id}_${Date.now()}_${file.name}`; // Unique file name
            const storageRef = storage.ref(`photos/${fileName}`);
            const uploadTask = storageRef.put(file);
            
            const progress = document.getElementById('uploadProgress');
            progress.classList.remove('hidden');

            uploadTask.on('state_changed', 
                (snapshot) => {
                    const percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progress.value = percentage;
                }, 
                (error) => {
                    console.error("Upload failed:", error);
                    alert("写真のアップロードに失敗しました。");
                    progress.classList.add('hidden');
                }, 
                () => {
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        console.log('File available at', downloadURL);
                        document.getElementById('photoUrl').value = downloadURL;
                        document.getElementById('photoPreview').src = downloadURL;
                        progress.classList.add('hidden');
                        // Immediately save the new URL to the person's document
                        savePerson({ id: id, photoUrl: downloadURL });
                    });
                }
            );
            event.target.value = null; // Reset file input
        }

        function createDateSelectors(containerId, initialDate, isRequired = false) {
             const container = document.getElementById(containerId); container.innerHTML = ''; const yearSelect = document.createElement('select'); const monthSelect = document.createElement('select'); const daySelect = document.createElement('select'); if(isRequired) [yearSelect, monthSelect, daySelect].forEach(s => s.required = true); yearSelect.innerHTML = `<option value="">年</option>`; monthSelect.innerHTML = `<option value="">月</option>`; daySelect.innerHTML = `<option value="">日</option>`; const currentYear = new Date().getFullYear(); for (let y = currentYear + 5; y >= 1900; y--) yearSelect.innerHTML += `<option value="${y}">${y}</option>`; for (let m = 1; m <= 12; m++) monthSelect.innerHTML += `<option value="${m}">${m}</option>`; container.append(yearSelect, monthSelect, daySelect); const updateDays = () => { const year = parseInt(yearSelect.value); const month = parseInt(monthSelect.value); const currentDay = daySelect.value; daySelect.innerHTML = `<option value="">日</option>`; if (year && month) { const daysInMonth = new Date(year, month, 0).getDate(); for (let d = 1; d <= daysInMonth; d++) daySelect.innerHTML += `<option value="${d}">${d}</option>`; daySelect.value = currentDay; } }; yearSelect.addEventListener('change', updateDays); monthSelect.addEventListener('change', updateDays); if (initialDate && /^\d{4}-\d{2}-\d{2}$/.test(initialDate)) { const [year, month, day] = initialDate.split('-').map(Number); yearSelect.value = year; monthSelect.value = month; updateDays(); daySelect.value = day; }
        }
        function getDateFromSelectors(containerId) { /* ... function content remains the same */ }
        function populateSelectOptions(currentPersonId = null) { /* ... function content remains the same */ }
        function populateCategorySelect(selectElement) { /* ... function content remains the same */ }
        
        function renderCategoryIconFilter() {
            categoryFilterContainer.innerHTML = '';

            // "全て"のアイコン
            const allIcon = document.createElement('div');
            allIcon.className = `category-icon ${settings.selectedCategoryFilter === 'all' ? 'selected' : ''}`;
            allIcon.dataset.category = 'all';
            allIcon.title = '全ての人物';
            allIcon.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><path d="M17 17H2V5h12a3 3 0 0 1 3 3v1a3 3 0 0 1 3 3v2h-2"></path><path d="M17 17v-5h6"></path></svg>
            `;
            categoryFilterContainer.appendChild(allIcon);

            familyCategories.forEach(category => {
                if (category === '（未分類）') return; // 「（未分類）」は別途「全て」に含まれる

                const icon = document.createElement('div');
                icon.className = `category-icon ${settings.selectedCategoryFilter === category ? 'selected' : ''}`;
                icon.dataset.category = category;
                icon.title = category;
                // カテゴリー名の頭文字を表示
                icon.textContent = category.charAt(0);
                categoryFilterContainer.appendChild(icon);
            });
        }

        function closePersonModal() { personModal.classList.add('hidden'); personModal.classList.remove('flex'); }
        function openSettingsModal() { renderCategoryManager(); populateSelectOptions(); document.getElementById('rootPersonId').value = settings.rootPersonId || ''; settingsModal.classList.add('flex'); settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); settingsModal.classList.remove('flex'); }
        function renderCategoryManager() { /* ... function content remains the same */ }
        function applyTheme() { document.documentElement.classList.toggle('dark', settings.theme === 'dark'); }
        function applySettings() { applyTheme(); const themeRadio = document.querySelector(`input[name="theme"][value="${settings.theme}"]`); if (themeRadio) themeRadio.checked = true; }
        function calculateAge(birthdate, deathdate = null) { /* ... function content remains the same */ }
        
        function getAgeDisplay(person) {
            if (person.isDeceased) {
                const ageIfAlive = calculateAge(person.birthdate);
                return `故人 (生きていれば ${ageIfAlive}歳)`;
            }
            const age = calculateAge(person.birthdate);
            return `${age}歳`;
        }

        function createPersonCard(person) {
            const card = document.createElement('div');
            card.className = `p-4 rounded-lg soft-shadow bg-white dark:bg-slate-800 flex flex-col cursor-pointer`;
            card.dataset.id = person.id;
            
            const ageDisplay = getAgeDisplay(person);
            const events = calculateEvents(person);
            const avatarSrc = person.photoUrl || generateAvatar(person);
            const commentHTML = person.comment ? `<p class="text-sm font-semibold accent-text truncate">“${person.comment}”</p>` : '';

            card.innerHTML = `
                <div class="flex items-start space-x-3">
                    <img src="${avatarSrc}" class="w-16 h-16 rounded-full object-cover" alt="${person.name}の写真">
                    <div class="flex-1 overflow-hidden">
                        <div class="flex justify-between items-start">
                            <h3 class="font-bold text-lg truncate">${person.name}</h3>
                            <span class="text-xs sm:text-sm font-semibold ${person.isDeceased ? 'text-slate-400' : 'accent-text'} whitespace-nowrap">${ageDisplay}</span>
                        </div>
                        <p class="text-sm text-slate-500 dark:text-slate-400 truncate">${person.kana || ''}</p>
                        ${commentHTML}
                        ${person.company ? `<p class="text-xs text-slate-500 dark:text-slate-400 truncate">所属: ${person.company}</p>` : ''}
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-slate-200 dark:border-slate-700 text-xs text-slate-600 dark:text-slate-300 space-y-1 flex-1">
                    <p><strong>誕生日:</strong> ${formatDateJP(person.birthdate)}</p>
                    <div class="max-h-24 overflow-y-auto space-y-1 pr-2">${events.map(e => `<p><strong>${e.name}:</strong> ${formatDateJP(e.date)}</p>`).join('')}</div>
                </div>`;
            return card;
        }

        function buildTreeLayout(rootPerson, personData) {
            const findPerson = (id) => personData.find(p => p.id === id); 
            const getChildren = (id) => personData.filter(p => (p.fatherId === id || p.motherId === id) && p.id !== id); 

            let nodes = [], links = [], positions = {}, generationLevels = {}, bounds = { minX: 0, maxX: 0, minY: 0, maxY: 0 }, visited = new Set(); 

            // DFS to build generations and establish initial relative order
            function traverse(person, level) { 
                if (!person || visited.has(person.id)) return; 
                visited.add(person.id); 

                if (!generationLevels[level]) generationLevels[level] = []; 
                if (!generationLevels[level].includes(person.id)) generationLevels[level].push(person.id); 

                const father = findPerson(person.fatherId);
                const mother = findPerson(person.motherId);
                const spouse = findPerson(person.spouseId);

                // Traverse parents first
                if (father) traverse(father, level - 1);
                if (mother) traverse(mother, level - 1);

                // Traverse spouse
                if (spouse) traverse(spouse, level);

                // Traverse children
                getChildren(person.id).forEach(child => traverse(child, level + 1));
            } 
            traverse(rootPerson, 0); 

            const validLevels = Object.keys(generationLevels).map(Number).filter(isFinite); 
            if (validLevels.length === 0) return { nodes: [], links: [], bounds: { minX: 0, maxX: 0, minY: 0, maxY: 0 } }; 

            const minLevel = Math.min(...validLevels); 
            
            // Assign X positions based on order within a generation
            Object.keys(generationLevels).sort((a,b) => Number(a)-Number(b)).forEach(level => { 
                const y = (Number(level) - minLevel) * (nodeSize.height + nodeGap.y); 
                const levelPersonIds = generationLevels[level];
                
                // Sort within level to maintain some visual consistency (e.g., by birthdate or name)
                levelPersonIds.sort((idA, idB) => {
                    const personA = findPerson(idA);
                    const personB = findPerson(idB);
                    if (!personA || !personB) return 0;
                    if (personA.birthdate && personB.birthdate) {
                        return new Date(personA.birthdate) - new Date(personB.birthdate);
                    }
                    return (personA.kana || personA.name).localeCompare(personB.kana || personB.name, 'ja');
                });

                let x = - (levelPersonIds.length * (nodeSize.width + nodeGap.x) - nodeGap.x) / 2; // Center nodes horizontally
                
                levelPersonIds.forEach(id => { 
                    if (!positions[id]) positions[id] = { x, y }; 
                    x += nodeSize.width + nodeGap.x; 
                }); 
            }); 

            const drawnLinks = new Set(); 
            
            visited.forEach(id => { 
                const person = findPerson(id), pos = positions[id]; 
                if (!person || !pos) return; 

                nodes.push({ id: person.id, person, x: pos.x, y: pos.y }); 
                
                bounds.minX = Math.min(bounds.minX, pos.x); 
                bounds.maxX = Math.max(bounds.maxX, pos.x); 
                bounds.minY = Math.min(bounds.minY, pos.y); 
                bounds.maxY = Math.max(bounds.maxY, pos.y); 

                // Spouse link
                if(person.spouseId && positions[person.spouseId] && person.id < person.spouseId) { 
                    const spousePos = positions[person.spouseId]; 
                    const linkKey = [person.id, person.spouseId].sort().join('-');
                    if (!drawnLinks.has(linkKey)) {
                         if (Math.abs(pos.y - spousePos.y) < nodeGap.y / 2) { // Only link if on same or very close level
                             links.push({d: `M ${pos.x + nodeSize.width} ${pos.y + nodeSize.height / 2} H ${spousePos.x}`}); 
                             drawnLinks.add(linkKey);
                         }
                    }
                } 

                // Parent-child links (collectively from parents to children)
                const children = getChildren(person.id);
                if (children.length > 0) {
                    const childNodes = children.map(c => ({ id: c.id, pos: positions[c.id], parent: c.fatherId === person.id ? 'father' : 'mother' }));
                    
                    // Filter children that are actually at the next level
                    const validChildren = childNodes.filter(c => c.pos && c.pos.y > pos.y);

                    if (validChildren.length > 0) {
                        // Find midpoints for drawing vertical lines from parents
                        const parentCenter = { x: pos.x + nodeSize.width / 2, y: pos.y + nodeSize.height };
                        
                        // Collect all child x positions to find min/max
                        const childXPositions = validChildren.map(c => c.pos.x + nodeSize.width / 2);
                        const minChildX = Math.min(...childXPositions);
                        const maxChildX = Math.max(...childXPositions);

                        const middleX = (minChildX + maxChildX) / 2;
                        const verticalLineY = parentCenter.y + nodeGap.y / 2; // Mid-point between parent and child generations

                        // Horizontal line from parent to center of children group
                        links.push({d: `M ${parentCenter.x} ${parentCenter.y} V ${verticalLineY}`});
                        
                        // If there are multiple parents for a child, or siblings, draw a horizontal line
                        if (validChildren.length > 0 || (person.spouseId && findPerson(person.spouseId) && findPerson(person.spouseId).id < person.id)) {
                             links.push({d: `M ${Math.min(parentCenter.x, middleX)} ${verticalLineY} H ${Math.max(parentCenter.x, middleX)}`});
                        }

                        validChildren.forEach(child => {
                            const childCenter = { x: child.pos.x + nodeSize.width / 2, y: child.pos.y };
                            links.push({d: `M ${childCenter.x} ${verticalLineY} V ${childCenter.y}`});
                        });
                    }
                }
            });
            return { nodes, links, bounds }; 
        }

        init();
    });
    </script>
</body>
</html>
